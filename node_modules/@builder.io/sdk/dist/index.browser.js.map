{"version":3,"file":"index.browser.js","sources":["../src/polyfills/custom-event-polyfill.js","../src/functions/next-tick.function.ts","../src/classes/query-string.class.ts","../src/classes/observable.class.ts","../src/classes/promise.class.ts","../src/functions/server-only-require.function.ts","../src/functions/fetch.function.ts","../src/functions/assign.function.ts","../src/functions/throttle.function.ts","../src/classes/animator.class.ts","../src/functions/get-top-level-domain.ts","../src/classes/cookies.class.ts","../src/functions/omit.function.ts","../src/functions/uuid.ts","../node_modules/hash-sum/hash-sum.js","../src/builder.class.ts","../src/constants/builder.ts"],"sourcesContent":["(function () {\n  if (typeof window === 'undefined' || typeof window.CustomEvent === 'function') return false;\n\n  function CustomEvent(event, params) {\n    params = params || { bubbles: false, cancelable: false, detail: null };\n    var evt = document.createEvent('CustomEvent');\n    evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);\n    return evt;\n  }\n\n  window.CustomEvent = CustomEvent;\n})();\n","const isSafari =\n  typeof window !== 'undefined' &&\n  /^((?!chrome|android).)*safari/i.test(window.navigator.userAgent);\n\nconst isClient = typeof window !== 'undefined';\n\n// TODO: queue all of these in a debounceNextTick\nexport function nextTick(fn: () => void) {\n  // React native\n  if (typeof setImmediate === 'function' && typeof window === 'undefined') {\n    return setImmediate(fn);\n  }\n  // TODO: should this be setImmediate instead? Forgot if that is micro or macro task\n  // TODO: detect specifically if is server\n  // if (typeof process !== 'undefined' && process.nextTick) {\n  //   console.log('process.nextTick?');\n  //   process.nextTick(fn);\n  //   return;\n  // }\n  // FIXME: fix the real safari issue of this randomly not working\n  if (isSafari || typeof MutationObserver === 'undefined') {\n    setTimeout(fn);\n    return;\n  }\n  let called = 0;\n  const observer = new MutationObserver(() => fn());\n  const element = document.createTextNode('');\n  observer.observe(element, {\n    characterData: true,\n  });\n  // tslint:disable-next-line\n  element.data = String((called = ++called));\n}\n","export type StringMap = Record<string, string>;\n\nconst PROPERTY_NAME_DENY_LIST = Object.freeze(['__proto__', 'prototype', 'constructor']);\n\n// TODO: unit tests\nexport class QueryString {\n  static parseDeep(queryString: string) {\n    const obj = this.parse(queryString);\n    return this.deepen(obj);\n  }\n\n  static stringifyDeep(obj: any) {\n    const map = this.flatten(obj);\n    return this.stringify(map);\n  }\n\n  static parse(queryString: string): StringMap {\n    const query: StringMap = {};\n    const pairs = (queryString[0] === '?' ? queryString.substr(1) : queryString).split('&');\n    for (let i = 0; i < pairs.length; i++) {\n      const pair = pairs[i].split('=');\n      // TODO: node support?\n      try {\n        query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');\n      } catch (error) {\n        // Ignore malformed URI components\n      }\n    }\n    return query;\n  }\n\n  static stringify(map: StringMap) {\n    let str = '';\n    for (const key in map) {\n      if (map.hasOwnProperty(key)) {\n        const value = map[key];\n        if (str) {\n          str += '&';\n        }\n        str += encodeURIComponent(key) + '=' + encodeURIComponent(value);\n      }\n    }\n    return str;\n  }\n\n  static deepen(map: StringMap) {\n    // FIXME; Should be type Tree = Record<string, string | Tree>\n    // requires a typescript upgrade.\n    const output: any = {};\n    for (const k in map) {\n      let t = output;\n      const parts = k.split('.');\n      const key = parts.pop()!;\n      for (const part of parts) {\n        assertAllowedPropertyName(part);\n        t = t[part] = t[part] || {};\n      }\n      t[key] = map[k];\n    }\n    return output;\n  }\n\n  static flatten(obj: any, _current?: any, _res: any = {}): StringMap {\n    for (const key in obj) {\n      const value = obj[key];\n      const newKey = _current ? _current + '.' + key : key;\n      if (value && typeof value === 'object') {\n        this.flatten(value, newKey, _res);\n      } else {\n        _res[newKey] = value;\n      }\n    }\n\n    return _res;\n  }\n}\n\nfunction assertAllowedPropertyName(name: string): asserts name {\n  if (PROPERTY_NAME_DENY_LIST.indexOf(name) >= 0)\n    throw new Error(`Property name \"${name}\" is not allowed`);\n}\n","export type Listener<T> = (value: T) => void;\n\nexport class Subscription<FunctionType = Function> {\n  constructor(private listeners?: FunctionType[], private listener?: FunctionType) {}\n\n  unsubscribed = false;\n\n  get closed() {\n    return this.unsubscribed;\n  }\n\n  private readonly otherSubscriptions: Subscription[] = [];\n\n  add(subscription: Subscription) {\n    this.otherSubscriptions.push(subscription);\n  }\n\n  unsubscribe() {\n    if (this.unsubscribed) {\n      return;\n    }\n    if (this.listener && this.listeners) {\n      const index = this.listeners.indexOf(this.listener);\n      if (index > -1) {\n        this.listeners.splice(index, 1);\n      }\n    }\n    this.otherSubscriptions.forEach(sub => sub.unsubscribe());\n    this.unsubscribed = true;\n  }\n}\n\n// TODO: follow minimal basic spec: https://github.com/tc39/proposal-observable\nexport class BehaviorSubject<T = any, ErrorType = any> {\n  constructor(public value: T) {}\n\n  private listeners: Listener<T>[] = [];\n  private errorListeners: Listener<ErrorType>[] = [];\n\n  next(value: T) {\n    this.value = value;\n    for (const listener of this.listeners) {\n      listener(value);\n    }\n  }\n\n  // TODO: implement this as PIPE instead\n  map<NewType = any>(fn: (item: T) => NewType) {\n    const newSubject = new BehaviorSubject<NewType>(fn(this.value));\n    // TODO: on destroy delete these\n    this.subscribe(val => {\n      newSubject.next(fn(val));\n    });\n    this.catch(err => {\n      newSubject.error(err);\n    });\n    return newSubject;\n  }\n\n  catch(errorListener: Listener<ErrorType>) {\n    this.errorListeners.push(errorListener);\n    return new Subscription(this.errorListeners, errorListener);\n  }\n\n  error(error: ErrorType) {\n    for (const listener of this.errorListeners) {\n      listener(error);\n    }\n  }\n\n  subscribe(listener: Listener<T>, errorListener?: Listener<ErrorType>) {\n    this.listeners.push(listener);\n    if (errorListener) {\n      this.errorListeners.push(errorListener);\n    }\n    return new Subscription(this.listeners, listener);\n  }\n\n  toPromise() {\n    return new Promise<T>((resolve, reject) => {\n      const subscription = this.subscribe(\n        value => {\n          resolve(value);\n          subscription.unsubscribe();\n        },\n        err => {\n          reject(err);\n          subscription.unsubscribe();\n        }\n      );\n    });\n  }\n\n  promise() {\n    return this.toPromise();\n  }\n}\n\n// TODO: make different classes\nexport const Observer = BehaviorSubject;\nexport const Observable = BehaviorSubject;\n","import { nextTick } from '../functions/next-tick.function';\n\nconst State = {\n  Pending: 'Pending',\n  Fulfilled: 'Fulfilled',\n  Rejected: 'Rejected',\n};\n\nfunction isFunction(val: any) {\n  return val && typeof val === 'function';\n}\n\nfunction isObject(val: any) {\n  return val && typeof val === 'object';\n}\n\ninterface Handler<T> {\n  onFulfilled: (val: T) => any;\n  onRejected: (err: any) => any;\n}\n\nexport class TinyPromise<T = any> {\n  private _state = State.Pending;\n  private _handlers: Handler<T>[] = [];\n  private _value: T | null = null;\n\n  constructor(executor: (resolve: (val: T) => any, reject: (err: T) => any) => void) {\n    executor(this._resolve.bind(this), this._reject.bind(this));\n  }\n\n  private _resolve(x: any) {\n    if (x instanceof TinyPromise) {\n      x.then(this._resolve.bind(this), this._reject.bind(this));\n    } else if (isObject(x) || isFunction(x)) {\n      let called = false;\n      try {\n        const thenable = (x as Promise<any>).then;\n        if (isFunction(thenable)) {\n          thenable.call(\n            x,\n            (result: any) => {\n              if (!called) this._resolve(result);\n              called = true;\n              return undefined as any;\n            },\n            (error: any) => {\n              if (!called) this._reject(error);\n              called = true;\n              return undefined as any;\n            }\n          );\n        } else {\n          this._fulfill(x);\n        }\n      } catch (ex) {\n        if (!called) {\n          this._reject(ex);\n        }\n      }\n    } else {\n      this._fulfill(x);\n    }\n  }\n\n  private _fulfill(result: T) {\n    this._state = State.Fulfilled;\n    this._value = result;\n    this._handlers.forEach(handler => this._callHandler(handler));\n  }\n\n  private _reject(error: any) {\n    this._state = State.Rejected;\n    this._value = error;\n    this._handlers.forEach(handler => this._callHandler(handler));\n  }\n\n  private _isPending() {\n    return this._state === State.Pending;\n  }\n\n  private _isFulfilled() {\n    return this._state === State.Fulfilled;\n  }\n\n  private _isRejected() {\n    return this._state === State.Rejected;\n  }\n\n  private _addHandler(onFulfilled: (val: T) => any, onRejected: (err: any) => any) {\n    this._handlers.push({\n      onFulfilled,\n      onRejected,\n    });\n  }\n\n  private _callHandler(handler: Handler<T>) {\n    if (this._isFulfilled() && isFunction(handler.onFulfilled)) {\n      handler.onFulfilled(this._value as T);\n    } else if (this._isRejected() && isFunction(handler.onRejected)) {\n      handler.onRejected(this._value);\n    }\n  }\n\n  then(onFulfilled: (val: T) => any, onRejected: (err: any) => any) {\n    switch (this._state) {\n      case State.Pending: {\n        return new TinyPromise((resolve, reject) => {\n          this._addHandler(\n            value => {\n              nextTick(() => {\n                try {\n                  if (isFunction(onFulfilled)) {\n                    resolve(onFulfilled(value));\n                  } else {\n                    resolve(value);\n                  }\n                } catch (ex) {\n                  reject(ex);\n                }\n              });\n            },\n            error => {\n              nextTick(() => {\n                try {\n                  if (isFunction(onRejected)) {\n                    resolve(onRejected(error));\n                  } else {\n                    reject(error);\n                  }\n                } catch (ex) {\n                  reject(ex);\n                }\n              });\n            }\n          );\n        });\n      }\n\n      case State.Fulfilled: {\n        return new TinyPromise((resolve, reject) => {\n          nextTick(() => {\n            try {\n              if (isFunction(onFulfilled)) {\n                resolve(onFulfilled(this._value as T));\n              } else {\n                resolve(this._value as T);\n              }\n            } catch (ex) {\n              reject(ex);\n            }\n          });\n        });\n      }\n\n      case State.Rejected: {\n        return new TinyPromise((resolve, reject) => {\n          nextTick(() => {\n            try {\n              if (isFunction(onRejected)) {\n                resolve(onRejected(this._value));\n              } else {\n                reject(this._value);\n              }\n            } catch (ex) {\n              reject(ex);\n            }\n          });\n        });\n      }\n    }\n  }\n}\n\nexport default (typeof Promise !== 'undefined' ? Promise : TinyPromise) as PromiseConstructor;\n","// Webpack workaround to conditionally require certain external modules\n// only on the server and not bundle them on the client\nlet serverOnlyRequire: NodeRequire;\ntry {\n  // tslint:disable-next-line:no-eval\n  serverOnlyRequire = eval('require');\n} catch (err) {\n  // all good\n  serverOnlyRequire = (() => null) as any;\n}\n\nexport default serverOnlyRequire;\n","import Promise from '../classes/promise.class';\nimport serverOnlyRequire from './server-only-require.function';\n\nexport interface SimplifiedFetchOptions {\n  body?: string;\n  headers?: { [key: string]: string };\n  method?: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\n  credentials?: 'include';\n  mode?: string;\n}\n\nexport interface SimpleFetchResponse {\n  ok: boolean;\n  status: number;\n  statusText: string;\n  url: string;\n  clone: () => any;\n  text: () => Promise<string>;\n  json: () => Promise<any>;\n  blob: () => Promise<Blob>;\n  headers: {\n    keys: () => string[];\n    entries: () => [string, string][];\n    get: (n: string) => string;\n    has: (n: string) => boolean;\n  };\n}\n\nfunction promiseResolve<T>(value: T) {\n  return new Promise<T>(resolve => resolve(value));\n}\n\n// Adapted from https://raw.githubusercontent.com/developit/unfetch/master/src/index.mjs\nexport function tinyFetch(url: string, options: SimplifiedFetchOptions = {}) {\n  return new Promise<SimpleFetchResponse>((resolve, reject) => {\n    const request = new XMLHttpRequest();\n\n    request.open(options.method || 'get', url, true);\n\n    if (options.headers) {\n      for (const i in options.headers) {\n        request.setRequestHeader(i, options.headers[i]);\n      }\n    }\n\n    request.withCredentials = options.credentials === 'include';\n\n    request.onload = () => {\n      resolve(response());\n    };\n\n    request.onerror = reject;\n\n    request.send(options.body);\n\n    function response() {\n      const keys: string[] = [];\n      const all: [string, string][] = [];\n      const headers: { [key: string]: string } = {};\n      let header: string | undefined = undefined;\n\n      request\n        .getAllResponseHeaders()\n        .replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm, (_match, _key, value) => {\n          let key = _key;\n          keys.push((key = key.toLowerCase()));\n          all.push([key, value]);\n          header = headers[key];\n          headers[key] = header ? `${header},${value}` : value;\n          return '';\n        });\n\n      return {\n        ok: ((request.status / 100) | 0) === 2, // 200-299\n        status: request.status,\n        statusText: request.statusText,\n        url: request.responseURL,\n        clone: response,\n        text: () => promiseResolve(request.responseText),\n        json: () => promiseResolve(request.responseText).then(JSON.parse),\n        blob: () => promiseResolve(new Blob([request.response])),\n        headers: {\n          keys: () => keys,\n          entries: () => all,\n          get: (n: string) => headers[n.toLowerCase()],\n          has: (n: string) => n.toLowerCase() in headers,\n        },\n      };\n    }\n  });\n}\n\nexport const fetch: typeof tinyFetch /* | typeof window.fetch */ =\n  typeof global === 'object' && typeof (global as any).fetch === 'function'\n    ? (global as any).fetch\n    : typeof window === 'undefined'\n    ? serverOnlyRequire('node-fetch')\n    : typeof window.fetch !== 'undefined'\n    ? window.fetch\n    : tinyFetch;\n","export function assign(target: object, ...args: any[]) {\n  const to = Object(target);\n\n  for (let index = 1; index < arguments.length; index++) {\n    const nextSource = arguments[index];\n\n    if (nextSource != null) {\n      // Skip over if undefined or null\n      for (const nextKey in nextSource) {\n        // Avoid bugs when hasOwnProperty is shadowed\n        if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {\n          to[nextKey] = nextSource[nextKey];\n        }\n      }\n    }\n  }\n  return to;\n}\n","export function throttle(func: Function, wait: number, options: any = {}) {\n  let context: any;\n  let args: any;\n  let result: any;\n  let timeout = null as any;\n  let previous = 0;\n  const later = function () {\n    previous = options.leading === false ? 0 : Date.now();\n    timeout = null;\n    result = func.apply(context, args);\n    if (!timeout) context = args = null;\n  };\n  return function (this: any) {\n    const now = Date.now();\n    if (!previous && options.leading === false) previous = now;\n    const remaining = wait - (now - previous);\n    context = this;\n    args = arguments;\n    if (remaining <= 0 || remaining > wait) {\n      if (timeout) {\n        clearTimeout(timeout);\n        timeout = null;\n      }\n      previous = now;\n      result = func.apply(context, args);\n      if (!timeout) context = args = null;\n    } else if (!timeout && options.trailing !== false) {\n      timeout = setTimeout(later, remaining);\n    }\n    return result;\n  };\n}\n","import { throttle } from '../functions/throttle.function';\nimport { assign } from '../functions/assign.function';\n\nconst camelCaseToKebabCase = (str?: string) =>\n  str ? str.replace(/([A-Z])/g, g => `-${g[0].toLowerCase()}`) : '';\n\nexport interface AnimationStep {\n  // First one is always start state\n  // isStartState?: boolean;\n  styles: { [key: string]: string };\n  delay?: number;\n}\n\nexport interface Animation {\n  elementId: string;\n  trigger: string;\n  steps: AnimationStep[];\n  duration: number;\n  delay?: number;\n  easing?: string;\n  // TODO: deprecate - only here because of an API bug\n  id?: string;\n}\n\nexport class Animator {\n  bindAnimations(animations: Animation[]) {\n    for (const animation of animations) {\n      switch (animation.trigger) {\n        case 'pageLoad':\n          this.triggerAnimation(animation);\n          break;\n        case 'hover':\n          this.bindHoverAnimation(animation);\n          break;\n        case 'scrollInView':\n          this.bindScrollInViewAnimation(animation);\n          break;\n      }\n    }\n  }\n\n  private warnElementNotPresent(id: string) {\n    console.warn(`Cannot animate element: element with ID ${id} not found!`);\n  }\n\n  private augmentAnimation(animation: Animation, element: HTMLElement) {\n    const stylesUsed = this.getAllStylesUsed(animation);\n    const computedStyle: any = getComputedStyle(element);\n    // const computedStyle = getComputedStyle(element);\n    // // FIXME: this will break if original load is in one reponsive size then resize to another hmmm\n    // Need to use transform instead of left since left can change on screen sizes\n    const firstStyles = animation.steps[0].styles;\n    const lastStyles = animation.steps[animation.steps.length - 1]!.styles;\n    const bothStyles = [firstStyles, lastStyles];\n\n    // FIXME: this won't work as expected for augmented animations - may need the editor itself to manage this\n    for (const styles of bothStyles) {\n      for (const style of stylesUsed) {\n        if (!(style in styles)) {\n          styles[style] = computedStyle[style];\n        }\n      }\n    }\n  }\n\n  private getAllStylesUsed(animation: Animation) {\n    const properties: (keyof CSSStyleDeclaration)[] = [];\n    for (const step of animation.steps) {\n      for (const key in step.styles) {\n        if (properties.indexOf(key as any) === -1) {\n          properties.push(key as any);\n        }\n      }\n    }\n    return properties;\n  }\n\n  triggerAnimation(animation: Animation) {\n    // TODO: do for ALL elements\n    const elements = Array.prototype.slice.call(\n      document.getElementsByClassName(animation.elementId || animation.id || '')\n    ) as HTMLElement[];\n    if (!elements.length) {\n      this.warnElementNotPresent(animation.elementId || animation.id || '');\n      return;\n    }\n\n    Array.from(elements).forEach(element => {\n      this.augmentAnimation(animation, element);\n      // TODO: do this properly, may have other animations of different properties\n\n      // TODO: only override the properties\n      // TODO: if there is an entrance and hover animation, the transition duration will get effed\n      // element.setAttribute('style', '');\n\n      // const styledUsed = this.getAllStylesUsed(animation);\n      element.style.transition = 'none';\n      element.style.transitionDelay = '0';\n      assign(element.style, animation.steps[0].styles);\n      // TODO: queue/batch these timeouts\n      // TODO: only include properties explicitly set in the animation\n      // using Object.keys(styles)\n      setTimeout(() => {\n        element.style.transition = `all ${animation.duration}s ${camelCaseToKebabCase(\n          animation.easing\n        )}`;\n        if (animation.delay) {\n          element.style.transitionDelay = animation.delay + 's';\n        }\n        assign(element.style, animation.steps[1].styles);\n        // TODO: maybe remove/reset transitoin property after animation duration\n\n        // TODO: queue timers\n        setTimeout(() => {\n          // TODO: what if has other transition (reset back to what it was)\n          element.style.transition = '';\n          element.style.transitionDelay = '';\n        }, (animation.delay || 0) * 1000 + animation.duration * 1000 + 100);\n      });\n    });\n  }\n\n  bindHoverAnimation(animation: Animation) {\n    // TODO: is it multiple binding when editing...?\n    // TODO: unbind on element remove\n    // TODO: apply to ALL elements\n    const elements = Array.prototype.slice.call(\n      document.getElementsByClassName(animation.elementId || animation.id || '')\n    ) as HTMLElement[];\n    if (!elements.length) {\n      this.warnElementNotPresent(animation.elementId || animation.id || '');\n      return;\n    }\n\n    Array.from(elements).forEach(element => {\n      this.augmentAnimation(animation, element);\n\n      const defaultState = animation.steps[0].styles;\n      const hoverState = animation.steps[1].styles;\n      function attachDefaultState() {\n        assign(element!.style, defaultState);\n      }\n      function attachHoverState() {\n        assign(element!.style, hoverState);\n      }\n      attachDefaultState();\n      element.addEventListener('mouseenter', attachHoverState);\n      element.addEventListener('mouseleave', attachDefaultState);\n      // TODO: queue/batch these timeouts\n      setTimeout(() => {\n        element.style.transition = `all ${animation.duration}s ${camelCaseToKebabCase(\n          animation.easing\n        )}`;\n        if (animation.delay) {\n          element.style.transitionDelay = animation.delay + 's';\n        }\n      });\n    });\n  }\n\n  // TODO: unbind on element remove\n  bindScrollInViewAnimation(animation: Animation) {\n    // TODO: apply to ALL matching elements\n    const elements = Array.prototype.slice.call(\n      document.getElementsByClassName(animation.elementId || animation.id || '')\n    ) as HTMLElement[];\n    if (!elements.length) {\n      this.warnElementNotPresent(animation.elementId || animation.id || '');\n      return;\n    }\n\n    // TODO: if server side rendered and scrolled into view don't animate...\n    Array.from(elements).forEach(element => {\n      this.augmentAnimation(animation, element);\n\n      let triggered = false;\n      function immediateOnScroll() {\n        if (!triggered && isScrolledIntoView(element)) {\n          triggered = true;\n          setTimeout(() => {\n            assign(element!.style, animation.steps[1].styles);\n            document.removeEventListener('scroll', onScroll);\n            setTimeout(() => {\n              element.style.transition = '';\n              element.style.transitionDelay = '';\n            }, (animation.duration * 1000 + (animation.delay || 0)) * 1000 + 100);\n          });\n        }\n      }\n\n      // TODO: roll all of these in one for more efficiency of checking all the rects\n      const onScroll = throttle(immediateOnScroll, 200, { leading: false });\n\n      // TODO: fully in view or partially\n      function isScrolledIntoView(elem: HTMLElement) {\n        const rect = elem.getBoundingClientRect();\n\n        const windowHeight = window.innerHeight;\n\n        const thresholdPrecent = 0;\n        const threshold = thresholdPrecent * windowHeight;\n\n        // TODO: partial in view? or what if element is larger than screen itself\n        return (\n          rect.bottom > threshold && rect.top < windowHeight - threshold // Element is peeking top or bottom\n          // (rect.top > 0 && rect.bottom < window.innerHeight) || // element fits within the screen and is fully on screen (not hanging off at all)\n          // (rect.top < 0 && rect.bottom > window.innerHeight) // element is larger than the screen and hangs over the top and bottom\n        );\n      }\n\n      const defaultState = animation.steps[0].styles;\n      function attachDefaultState() {\n        assign(element!.style, defaultState);\n      }\n      attachDefaultState();\n\n      // TODO: queue/batch these timeouts!\n      setTimeout(() => {\n        element.style.transition = `all ${animation.duration}s ${camelCaseToKebabCase(\n          animation.easing\n        )}`;\n        if (animation.delay) {\n          element.style.transitionDelay = animation.delay + 's';\n        }\n      });\n\n      // TODO: one listener for everything\n      document.addEventListener('scroll', onScroll, { capture: true, passive: true } as any);\n\n      // Do an initial check\n      immediateOnScroll();\n    });\n  }\n}\n","/**\n * Only gets one level up from hostname\n * wwww.example.com -> example.com\n * www.example.co.uk -> example.co.uk\n */\nexport function getTopLevelDomain(host: string) {\n  const parts = host.split('.');\n  if (parts.length > 2) {\n    return parts.slice(1).join('.');\n  }\n  return host;\n}\n","/**\n * RegExp to match field-content in RFC 7230 sec 3.2\n *\n * field-content = field-vchar [ 1*( SP / HTAB ) field-vchar ]\n * field-vchar   = VCHAR / obs-text\n * obs-text      = %x80-FF\n */\nconst fieldContentRegExp = /^[\\u0009\\u0020-\\u007e\\u0080-\\u00ff]+$/;\n\nimport { IncomingMessage, ServerResponse } from 'http';\nimport { getTopLevelDomain } from '../functions/get-top-level-domain';\ninterface Options {\n  secure?: boolean;\n  expires?: Date;\n}\n\nclass Cookies {\n  secure?: boolean;\n\n  constructor(private request: IncomingMessage, private response: ServerResponse) {}\n\n  get(name: string) {\n    const header = this.request.headers['cookie'] as string;\n    if (!header) {\n      return;\n    }\n\n    const match = header.match(getPattern(name));\n    if (!match) {\n      return;\n    }\n\n    const value = match[1];\n    return value;\n  }\n\n  set(name: string, value: string, opts: Options) {\n    const res = this.response;\n    const req = this.request;\n    let headers = res.getHeader('Set-Cookie') || [];\n    // TODO: just make this always true\n    const secure =\n      this.secure !== undefined\n        ? !!this.secure\n        : (req as any).protocol === 'https' || (req.connection as any).encrypted;\n    const cookie = new Cookie(name, value, opts);\n\n    if (typeof headers === 'string') {\n      headers = [headers];\n    }\n\n    if (!secure && opts && opts.secure) {\n      throw new Error('Cannot send secure cookie over unencrypted connection');\n    }\n\n    cookie.secure = secure;\n    if (opts && 'secure' in opts) {\n      cookie.secure = !!opts.secure;\n    }\n\n    cookie.domain = req.headers.host && getTopLevelDomain(req.headers.host);\n\n    pushCookie(headers, cookie);\n\n    const setHeader = res.setHeader;\n    setHeader.call(res, 'Set-Cookie', headers);\n    return this;\n  }\n}\n\nclass Cookie {\n  path = '/';\n  expires?: Date;\n  domain: string | undefined = undefined;\n  httpOnly = true;\n  sameSite?: boolean | string = false;\n  secure = false;\n  overwrite = false;\n  name = '';\n  value = '';\n  maxAge?: number;\n\n  constructor(name: string, value: string, attrs: Options) {\n    if (!fieldContentRegExp.test(name)) {\n      throw new TypeError('argument name is invalid');\n    }\n\n    if (value && !fieldContentRegExp.test(value)) {\n      throw new TypeError('argument value is invalid');\n    }\n\n    if (!value) {\n      this.expires = new Date(0);\n    }\n\n    this.name = name;\n    this.value = value || '';\n\n    if (attrs.expires) {\n      this.expires = attrs.expires;\n    }\n    if (attrs.secure) {\n      this.secure = attrs.secure;\n    }\n  }\n\n  toString() {\n    return `${this.name}=${this.value}`;\n  }\n\n  toHeader() {\n    let header = this.toString();\n\n    if (this.maxAge) {\n      this.expires = new Date(Date.now() + this.maxAge);\n    }\n    if (this.path) {\n      header += `; path=${this.path}`;\n    }\n    if (this.expires) {\n      header += `; expires=${this.expires.toUTCString()}`;\n    }\n    if (this.domain) {\n      header += `; domain=${this.domain}`;\n    }\n\n    // TODO: samesite=none by default (?)\n    header += `; SameSite=${this.sameSite === true ? 'strict' : 'None'}`;\n\n    // TODO: On by default\n    if (this.secure) {\n      header += '; secure';\n    }\n    if (this.httpOnly) {\n      header += '; httponly';\n    }\n\n    return header;\n  }\n}\n\nfunction getPattern(name: string) {\n  return new RegExp(`(?:^|;) *${name.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, '\\\\$&')}=([^;]*)`);\n}\n\nfunction pushCookie(headers: any, cookie: Cookie) {\n  if (cookie.overwrite) {\n    for (let i = headers.length - 1; i >= 0; i--) {\n      if (headers[i].indexOf(`${cookie.name}=`) === 0) {\n        headers.splice(i, 1);\n      }\n    }\n  }\n\n  headers.push(cookie.toHeader());\n}\n\nexport default Cookies;\n","export function omit<T extends object>(obj: T, ...values: (keyof T)[]): Partial<T> {\n  const newObject = Object.assign({}, obj);\n  for (const key of values) {\n    delete (newObject as any)[key];\n  }\n  return newObject;\n}\n","/**\n * @credit https://stackoverflow.com/a/2117523\n */\nexport function uuidv4() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    var r = (Math.random() * 16) | 0,\n      v = c == 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\n/**\n * Slightly cleaner and smaller UUIDs\n */\nexport function uuid() {\n  return uuidv4().replace(/-/g, '');\n}\n","'use strict';\n\nfunction pad (hash, len) {\n  while (hash.length < len) {\n    hash = '0' + hash;\n  }\n  return hash;\n}\n\nfunction fold (hash, text) {\n  var i;\n  var chr;\n  var len;\n  if (text.length === 0) {\n    return hash;\n  }\n  for (i = 0, len = text.length; i < len; i++) {\n    chr = text.charCodeAt(i);\n    hash = ((hash << 5) - hash) + chr;\n    hash |= 0;\n  }\n  return hash < 0 ? hash * -2 : hash;\n}\n\nfunction foldObject (hash, o, seen) {\n  return Object.keys(o).sort().reduce(foldKey, hash);\n  function foldKey (hash, key) {\n    return foldValue(hash, o[key], key, seen);\n  }\n}\n\nfunction foldValue (input, value, key, seen) {\n  var hash = fold(fold(fold(input, key), toString(value)), typeof value);\n  if (value === null) {\n    return fold(hash, 'null');\n  }\n  if (value === undefined) {\n    return fold(hash, 'undefined');\n  }\n  if (typeof value === 'object' || typeof value === 'function') {\n    if (seen.indexOf(value) !== -1) {\n      return fold(hash, '[Circular]' + key);\n    }\n    seen.push(value);\n\n    var objHash = foldObject(hash, value, seen)\n\n    if (!('valueOf' in value) || typeof value.valueOf !== 'function') {\n      return objHash;\n    }\n\n    try {\n      return fold(objHash, String(value.valueOf()))\n    } catch (err) {\n      return fold(objHash, '[valueOf exception]' + (err.stack || err.message))\n    }\n  }\n  return fold(hash, value.toString());\n}\n\nfunction toString (o) {\n  return Object.prototype.toString.call(o);\n}\n\nfunction sum (o) {\n  return pad(foldValue(0, o, '', []).toString(16), 8);\n}\n\nmodule.exports = sum;\n","import './polyfills/custom-event-polyfill';\nimport { IncomingMessage, ServerResponse } from 'http';\nimport { nextTick } from './functions/next-tick.function';\nimport { QueryString } from './classes/query-string.class';\nimport { version } from '../package.json';\nimport { BehaviorSubject } from './classes/observable.class';\nimport { fetch, SimplifiedFetchOptions } from './functions/fetch.function';\nimport { assign } from './functions/assign.function';\nimport { throttle } from './functions/throttle.function';\nimport { Animator } from './classes/animator.class';\nimport { BuilderElement } from './types/element';\nimport Cookies from './classes/cookies.class';\nimport { omit } from './functions/omit.function';\nimport { getTopLevelDomain } from './functions/get-top-level-domain';\nimport serverOnlyRequire from './functions/server-only-require.function';\nimport { BuilderContent } from './types/content';\nimport { uuid } from './functions/uuid';\n\n// Do not change this to a require! It throws runtime errors - rollup\n// will preserve the `require` and throw runtime errors\nimport hash from 'hash-sum';\n\nexport type Url = any;\n\nfunction datePlusMinutes(minutes = 30) {\n  return new Date(Date.now() + minutes * 60000);\n}\n\nconst isPositiveNumber = (thing: unknown) =>\n  typeof thing === 'number' && !isNaN(thing) && thing >= 0;\n\nexport const isReactNative = typeof navigator === 'object' && navigator.product === 'ReactNative';\n\nexport const validEnvList = [\n  'production',\n  'qa',\n  'test',\n  'development',\n  'dev',\n  'cdn-qa',\n  'cloud',\n  'fast',\n  'cdn2',\n  'cdn-prod',\n];\n\nfunction getQueryParam(url: string, variable: string): string | null {\n  const query = url.split('?')[1] || '';\n  const vars = query.split('&');\n  for (let i = 0; i < vars.length; i++) {\n    const pair = vars[i].split('=');\n    if (decodeURIComponent(pair[0]) === variable) {\n      return decodeURIComponent(pair[1]);\n    }\n  }\n  return null;\n}\n\nconst urlParser = {\n  parse(url: string) {\n    const parser = document.createElement('a') as any;\n    parser.href = url;\n    const out: any = {};\n    const props = 'username password host hostname port protocol origin pathname search hash'.split(\n      ' '\n    );\n    for (let i = props.length; i--; ) {\n      out[props[i]] = parser[props[i]];\n    }\n\n    // IE 11 pathname handling workaround\n    // (IE omits preceeding '/', unlike other browsers)\n    if (\n      (out.pathname || out.pathname === '') &&\n      typeof out.pathname === 'string' &&\n      out.pathname.indexOf('/') !== 0\n    ) {\n      out.pathname = '/' + out.pathname;\n    }\n\n    return out;\n  },\n};\n\nconst parse = isReactNative\n  ? () => ({})\n  : typeof window === 'object'\n  ? urlParser.parse\n  : serverOnlyRequire('url').parse;\n\nfunction setCookie(name: string, value: string, expires?: Date) {\n  try {\n    let expiresString = '';\n\n    // TODO: need to know if secure server side\n    if (expires) {\n      expiresString = '; expires=' + expires.toUTCString();\n    }\n\n    const secure = isBrowser ? location.protocol === 'https:' : true;\n    document.cookie =\n      name +\n      '=' +\n      (value || '') +\n      expiresString +\n      '; path=/' +\n      `; domain=${getTopLevelDomain(location.hostname)}` +\n      (secure ? ';secure ; SameSite=None' : '');\n  } catch (err) {\n    console.warn('Could not set cookie', err);\n  }\n}\n\nfunction getCookie(name: string) {\n  try {\n    return (\n      decodeURIComponent(\n        document.cookie.replace(\n          new RegExp(\n            '(?:(?:^|.*;)\\\\s*' +\n              encodeURIComponent(name).replace(/[\\-\\.\\+\\*]/g, '\\\\$&') +\n              '\\\\s*\\\\=\\\\s*([^;]*).*$)|^.*$'\n          ),\n          '$1'\n        )\n      ) || null\n    );\n  } catch (err) {\n    console.warn('Could not get cookie', err);\n  }\n}\n\nfunction size(object: object) {\n  return Object.keys(object).length;\n}\n\nfunction find<T = any>(target: T[], callback: (item: T, index: number, list: T[]) => boolean) {\n  const list = target;\n  // Makes sures is always has an positive integer as length.\n  const length = list.length >>> 0;\n  const thisArg = arguments[1];\n  for (let i = 0; i < length; i++) {\n    const element = list[i];\n    if (callback.call(thisArg, element, i, list)) {\n      return element;\n    }\n  }\n}\n\nconst sessionStorageKey = 'builderSessionId';\nconst localStorageKey = 'builderVisitorId';\n\nexport const isBrowser = typeof window !== 'undefined' && !isReactNative;\nexport const isIframe = isBrowser && window.top !== window.self;\n\nexport interface ParamsMap {\n  [key: string]: any;\n}\n\ntype TrackingHook = (\n  eventData: Event,\n  context: { content?: BuilderContent; [key: string]: any }\n) => Event | undefined;\n\ninterface EventData {\n  contentId?: string;\n  ownerId: string;\n  variationId?: string;\n  userAttributes?: any;\n  targetSelector?: string;\n  targetBuilderElement?: string;\n  unique?: boolean;\n  metadata?: any | string;\n  meta?: any | string;\n  sessionId?: string;\n  visitorId?: string;\n  amount?: number;\n}\n// TODO: share interfaces with API\ninterface Event {\n  type: string;\n  data: EventData;\n}\n\n/**\n * Attributes that can be used for custom targeting. {@link\n * https://www.builder.io/c/docs/guides/targeting-and-scheduling}\n */\nexport interface UserAttributes {\n  [key: string]:\n    | undefined\n    | string\n    | string[]\n    | boolean\n    | boolean[]\n    | number\n    | number[]\n    | Record<string, any>;\n  /**\n   * URL path of the current user.\n   */\n  urlPath?: string;\n  /** @deprecated */\n  queryString?: string | ParamsMap;\n  /** @deprecated */\n  device?: 'mobile' | 'tablet' | 'desktop';\n  /** @deprecated */\n  location?: any;\n  /** @deprecated */\n  userAgent?: string;\n  /** @deprecated */\n  referrer?: string;\n  /** @deprecated */\n  entryMedium?: string;\n  /** @deprecated */\n  language?: string;\n  /** @deprecated */\n  browser?: string;\n  /** @deprecated */\n  cookie?: string;\n  /** @deprecated */\n  newVisitor?: boolean;\n  /** @deprecated */\n  operatingSystem?: string;\n}\n\nexport interface GetContentOptions {\n  userAttributes?: UserAttributes;\n  /**\n   * Alias for userAttributes.urlPath except it can handle a full URL (optionally with host,\n   * protocol, query, etc) and we will parse out the path.\n   */\n  url?: string;\n  /**\n   * @package\n   */\n  includeUrl?: boolean;\n  /**\n   * Follow references. If you use the `reference` field to pull in other content without this\n   * enabled we will not fetch that content for the final response.\n   */\n  includeRefs?: boolean;\n  /**\n   * How long in seconds content should be cached for. Sets the max-age of the cache-control header\n   * response header.\n   *\n   * Use a higher value for better performance, lower for content that will change more frequently\n   *\n   * @see {@link https://www.builder.io/c/docs/query-api#__next:~:text=%26includeRefs%3Dtrue-,cacheSeconds,-No}\n   */\n  cacheSeconds?: number;\n  /**\n   * Builder.io uses stale-while-revalidate caching at the CDN level. This means we always serve\n   * from edge cache and update caches in the background for maximum possible performance. This also\n   * means that the more frequently content is requested, the more fresh it will be. The longest we\n   * will ever hold something in stale cache is 1 day by default, and you can set this to be shorter\n   * yourself as well. We suggest keeping this high unless you have content that must change rapidly\n   * and gets very little traffic.\n   *\n   * @see {@link https://www.fastly.com/blog/prevent-application-network-instability-serve-stale-content}\n   */\n  staleCacheSeconds?: number;\n  /**\n   * Maximum number of results to return. Defaults to `1`.\n   */\n  limit?: number;\n  /**\n   * Mongodb style query of your data. E.g.:\n   *\n   * ```\n   * &query.data.id=abc123\n   * &query.data.myCustomField=someValue\n   * &query.data.someNumber.$ne=20\n   * ```\n   *\n   * See more info on MongoDB's query operators and format.\n   *\n   * @see {@link https://docs.mongodb.com/manual/reference/operator/query/}\n   */\n  query?: any;\n  /**\n   * Bust through all caches. Not recommended for production (for performance),\n   * but can be useful for development and static builds (so the static site has\n   * fully fresh / up to date content)\n   */\n  cachebust?: boolean;\n  /**\n   * Convert any visual builder content to HTML.\n   *\n   * This will be on data.html of the response's content entry object json.\n   */\n  prerender?: boolean;\n  /**\n   * Extract any styles to a separate css property when generating HTML.\n   */\n  extractCss?: boolean;\n  /**\n   * Pagination results offset. Defaults to zero.\n   */\n  offset?: number;\n  /**\n   * @package\n   *\n   * `BuilderContent` to render instead of fetching.\n   */\n  initialContent?: any;\n  /**\n   * The name of the model to fetch content for.\n   */\n  model?: string;\n  /**\n   * Set to `false` to not cache responses when running on the client.\n   */\n  cache?: boolean;\n  /**\n   * @package\n   *\n   * Indicate that the fetch request is for preview purposes.\n   */\n  preview?: boolean;\n  /**\n   * Specific content entry ID to fetch.\n   */\n  entry?: string;\n  /**\n   * @package\n   * @deprecated\n   */\n  alias?: string;\n  fields?: string;\n  /**\n   * Omit only these fields.\n   *\n   * @example\n   * ```\n   * &omit=data.bigField,data.blocks\n   * ```\n   */\n  omit?: string;\n  key?: string;\n  /**\n   * @package\n   *\n   * Affects HTML generation for specific targets.\n   */\n  format?: 'amp' | 'email' | 'html' | 'react' | 'solid';\n  /** @deprecated */\n  noWrap?: true;\n  /**\n   * @package\n   *\n   * Specific string to use for cache busting. e.g. every time we generate\n   * HTML we generate a rev (a revision ID) and we send that with each request\n   * on the client, such that if we generate new server HTML we get a new rev\n   * and we use that to bust the cache because even though the content ID may\n   * be the same, it could be an updated version of this content that needs to\n   * be fresh.\n   */\n  rev?: string;\n  /**\n   * @package\n   *\n   * Tell the API that when generating HTML to generate it in static mode for\n   * a/b tests instead of the older way we did this\n   */\n  static?: boolean;\n  /**\n   * Additional query params of the Content API to send.\n   */\n  options?: { [key: string]: any };\n  /**\n   * @package\n   *\n   * Don't listen to updates in the editor - this is useful for embedded\n   * symbols so they don't accidentally listen to messages as you are editing\n   * content thinking they should updates when they actually shouldn't.\n   */\n  noEditorUpdates?: boolean;\n}\n\nexport type Class = {\n  name?: string;\n  new (...args: any[]): any;\n};\n\ninterface Map<K, V> {\n  clear(): void;\n  delete(key: K): boolean;\n  entries(): IterableIterator<[K, V]>;\n  forEach(callbackfn: (value: V, index: K, map: Map<K, V>) => void, thisArg?: any): void;\n  get(key: K): V;\n  has(key: K): boolean;\n  keys(): IterableIterator<K>;\n  set(key: K, value?: V): Map<K, V>;\n  size: number;\n  values(): IterableIterator<V>;\n  [Symbol.iterator](): IterableIterator<[K, V]>;\n}\n\nexport interface Input {\n  name: string;\n  friendlyName?: string;\n  description?: string;\n  defaultValue?: any;\n  type: string;\n  required?: boolean;\n  autoFocus?: boolean;\n  subFields?: Input[];\n  helperText?: string;\n  allowedFileTypes?: string[];\n  imageHeight?: number;\n  imageWidth?: number;\n  mediaHeight?: number;\n  mediaWidth?: number;\n  hideFromUI?: boolean;\n  modelId?: string;\n  /**\n   * Number field type validation maximum accepted input\n   */\n  max?: number;\n  /**\n   * Number field type validation minimum accepted input\n   */\n  min?: number;\n  /**\n   * Number field type step size when using arrows\n   */\n  step?: number;\n\n  /**\n   * Set this to `true` to show the editor for this input when\n   * children of this component are selected. This is useful for things\n   * like Tabs, such that users may not always select the Tabs component\n   * directly but will still be looking for how to add additional tabs\n   */\n  broadcast?: boolean;\n  /**\n   * Set this to `true` to show the editor for this input when\n   * group locked parents of this component are selected. This is useful\n   * to bubble up important inputs for locked groups, like text and images\n   */\n  bubble?: boolean;\n  options?: { [key: string]: any };\n  enum?: string[] | { label: string; value: any; helperText?: string }[];\n  /** Regex field validation for all string types (text, longText, html, url, etc) */\n  regex?: {\n    /** pattern to test, like \"^\\/[a-z]$\" */\n    pattern: string;\n    /** flags for the RegExp constructor, e.g. \"gi\"  */\n    options?: string;\n    /**\n     * Friendly message to display to end-users if the regex fails, e.g.\n     * \"You must use a relative url starting with '/...' \"\n     */\n    message: string;\n  };\n  advanced?: boolean;\n  onChange?: Function | string;\n  code?: boolean;\n  richText?: boolean;\n  showIf?: ((options: Map<string, any>) => boolean) | string;\n  copyOnAdd?: boolean;\n}\n\nexport interface Component {\n  /**\n   * Name your component something unique, e.g. 'MyButton'. You can override built-in components\n   * by registering a component with the same name, e.g. 'Text', to replace the built-in text component\n   */\n  name: string;\n  description?: string;\n  /**\n   * Link to a documentation page for this component\n   */\n  docsLink?: string;\n  image?: string;\n  /**\n   * Input schema for your component for users to fill in the options\n   */\n  inputs?: Input[];\n  class?: any;\n  type?: 'angular' | 'webcomponent' | 'react' | 'vue';\n  defaultStyles?: { [key: string]: string };\n  /**\n   * Turn on if your component can accept children. Be sure to use in combination with\n   * withChildren(YourComponent) like here\n   * github.com/BuilderIO/builder/blob/master/examples/react-design-system/src/components/HeroWithChildren/HeroWithChildren.builder.js#L5\n   */\n  canHaveChildren?: boolean;\n  fragment?: boolean;\n  /**\n   * Do not wrap a component in a dom element. Be sure to use {...props.attributes} with this option\n   * like here github.com/BuilderIO/builder/blob/master/packages/react/src/blocks/forms/Input.tsx#L34\n   */\n  noWrap?: boolean;\n  /**\n   * Default children\n   */\n  defaultChildren?: BuilderElement[];\n  defaults?: Partial<BuilderElement>;\n  hooks?: { [key: string]: string | Function };\n  /**\n   * Hide your component in editor, useful for gradually deprecating components\n   */\n  hideFromInsertMenu?: boolean;\n  // For webcomponents\n  tag?: string;\n  static?: boolean;\n  /**\n   * Passing a list of model names will restrict using the component to only the models listed here, otherwise it'll be available for all models\n   */\n  models?: string[];\n\n  /**\n   * Specify restrictions direct children must match\n   */\n  childRequirements?: {\n    /** Message to show when this doesn't match, e.g. \"Children of 'Columns' must be a 'Column'\" */\n    message: string;\n    /** Simple way to say children must be a specific component name */\n    component?: string;\n    /**\n     * More advanced - specify a MongoDB-style query (using sift.js github.com/crcn/sift.js)\n     * of what the children objects should match, e.g.\n     *\n     * @example\n     *  query: {\n     *    // Child of this element must be a 'Button' or 'Text' component\n     *    'component.name': { $in: ['Button', 'Text'] }\n     *  }\n     */\n    query?: any;\n  };\n\n  /**\n   * Specify restrictions any parent must match\n   */\n  requiresParent?: {\n    /** Message to show when this doesn't match, e.g. \"'Add to cart' buttons must be within a 'Product box'\" */\n    message: string;\n    /** Simple way to say a parent must be a specific component name, e.g. 'Product box' */\n    component?: string;\n\n    /**\n     * More advanced - specify a MongoDB-style query (using sift.js github.com/crcn/sift.js)\n     * of what at least one parent in the parents hierarchy should match, e.g.\n     *\n     * @example\n     *  query: {\n     *    // Thils element must be somewhere inside either a 'Product box' or 'Collection' component\n     *    'component.name': { $in: ['Product Box', 'Collection'] }\n     *  }\n     */\n    query?: any;\n  };\n\n  /** not yet implemented */\n  friendlyName?: string;\n\n  /**\n   * Use to restrict access to your component based on a the current user permissions\n   * By default components will show to all users\n   * for more information on permissions in builder check https://www.builder.io/c/docs/guides/roles-and-permissions\n   */\n  requiredPermissions?: Array<Permission>;\n}\n\ntype Permission = 'read' | 'publish' | 'editCode' | 'editDesigns' | 'admin' | 'create';\n\ntype DeepPartial<T> = {\n  [P in keyof T]?: T[P] extends Array<infer U>\n    ? Array<DeepPartial<U>>\n    : T[P] extends ReadonlyArray<infer U>\n    ? ReadonlyArray<DeepPartial<U>>\n    : DeepPartial<T[P]>;\n};\n\nexport interface InsertMenuItem {\n  name: string;\n  icon?: string;\n  item: DeepPartial<BuilderElement>;\n}\n\nexport interface InsertMenuConfig {\n  name: string;\n  priority?: number;\n  persist?: boolean;\n  advanced?: boolean;\n  items: InsertMenuItem[];\n}\n\nexport function BuilderComponent(info: Partial<Component> = {}) {\n  return Builder.Component(info);\n}\n\n// TODO\ntype Settings = any;\n\nexport interface Action {\n  name: string;\n  inputs?: Input[];\n  returnType?: Input;\n  action: Function | string;\n}\n\nexport class Builder {\n  static VERSION = version;\n\n  static components: Component[] = [];\n  static singletonInstance: Builder;\n  /**\n   * Makes it so that a/b tests generate code like {@link\n   * https://www.builder.io/blog/high-performance-no-code#__next:~:text=Static%20generated%20A%2FB%20testing}\n   * instead of the old way where we render only one test group at a time on the\n   * server. This is the preferred/better way not and we should ultimately make it\n   * the default\n   */\n  static isStatic = true;\n  static animator = new Animator();\n\n  static nextTick = nextTick;\n  static throttle = throttle;\n\n  static editors: any[] = [];\n  static trustedHosts: string[] = ['builder.io', 'localhost'];\n  static plugins: any[] = [];\n\n  static actions: Action[] = [];\n  static registry: { [key: string]: any[] } = {};\n  static overrideHost: string | undefined;\n\n  /**\n   * @todo `key` property on any info where if a key matches a current\n   * key it gets removed\n   */\n  static register(type: 'insertMenu', info: InsertMenuConfig): void;\n  static register(type: string, info: any): void;\n  static register(type: string, info: any) {\n    // TODO: all must have name and can't conflict?\n    let typeList = this.registry[type];\n    if (!typeList) {\n      typeList = this.registry[type] = [];\n    }\n    typeList.push(info);\n    if (Builder.isBrowser) {\n      const message = {\n        type: 'builder.register',\n        data: {\n          type,\n          info,\n        },\n      };\n      try {\n        parent.postMessage(message, '*');\n        if (parent !== window) {\n          window.postMessage(message, '*');\n        }\n      } catch (err) {\n        console.debug('Could not postmessage', err);\n      }\n    }\n    this.registryChange.next(this.registry);\n  }\n\n  static registryChange = new BehaviorSubject({} as typeof Builder.registry);\n\n  static registerEditor(info: any) {\n    if (Builder.isBrowser) {\n      window.postMessage(\n        {\n          type: 'builder.registerEditor',\n          data: omit(info, 'component'),\n        },\n        '*'\n      );\n      const { hostname } = location;\n\n      if (!Builder.isTrustedHost(hostname)) {\n        console.error(\n          'Builder.registerEditor() called in the wrong environment! You cannot load custom editors from your app, they must be loaded through the Builder.io app itself. Follow the readme here for more details: https://github.com/builderio/builder/tree/master/plugins/cloudinary or contact chat us in our Spectrum community for help: https://spectrum.chat/builder'\n        );\n      }\n    }\n    this.editors.push(info);\n  }\n\n  static registerPlugin(info: any) {\n    this.plugins.push(info);\n  }\n\n  static registerAction(action: Action) {\n    this.actions.push(action);\n  }\n\n  static registerTrustedHost(host: string) {\n    this.trustedHosts.push(host);\n  }\n\n  static isTrustedHost(hostname: string) {\n    return (\n      this.trustedHosts.findIndex(\n        trustedHost => trustedHost === hostname || hostname.endsWith(`.${trustedHost}`)\n      ) > -1\n    );\n  }\n\n  static runAction(action: Action | string) {\n    // TODO\n    const actionObject =\n      typeof action === 'string' ? find(this.actions, item => item.name === action) : action;\n\n    if (!actionObject) {\n      throw new Error(`Action not found: ${action}`);\n    }\n  }\n\n  static fields(name: string, fields: Input[]) {\n    window.parent?.postMessage(\n      {\n        type: 'builder.fields',\n        data: { name, fields },\n      },\n      '*'\n    );\n  }\n\n  private static _editingPage = false;\n\n  static isIframe = isIframe;\n  static isBrowser = isBrowser;\n  static isReactNative = isReactNative;\n  static isServer = !isBrowser && !isReactNative;\n  static previewingModel = Builder.isBrowser && getQueryParam(location.href, 'builder.preview');\n\n  static settings: Settings = {};\n  static settingsChange = new BehaviorSubject<Settings>({});\n\n  static set(settings: Settings) {\n    if (Builder.isBrowser) {\n      // TODO: merge\n      Object.assign(this.settings, settings);\n      const message = {\n        type: 'builder.settingsChange',\n        data: this.settings,\n      };\n      parent.postMessage(message, '*');\n    }\n    this.settingsChange.next(this.settings);\n  }\n\n  static import(packageName: string) {\n    if (!Builder.isBrowser) {\n      // TODO: server side support *maybe*\n      console.warn('Builder.import used on the server - this should only be used in the browser');\n      return;\n    }\n    const { System } = window as any;\n\n    if (!System) {\n      console.warn('System.js not available. Please include System.js when using Builder.import');\n      return;\n    }\n    return System.import(`https://cdn.builder.io/systemjs/${packageName}`);\n  }\n\n  // TODO: this is quick and dirty, do better implementation later. Also can be unreliable\n  // if page 301s etc. Use a query param instead? also could have issues with redirects. Injecting var could\n  // work but is async...\n  static isEditing = Boolean(\n    isIframe &&\n      ((document.referrer && document.referrer.match(/builder\\.io|localhost:1234/)) ||\n        location.search.indexOf('builder.frameEditing=') !== -1)\n  );\n\n  static isPreviewing = Boolean(\n    isBrowser &&\n      (location.search.indexOf('builder.preview=') !== -1 ||\n        location.search.indexOf('builder.frameEditing=') !== -1)\n  );\n\n  // useCdnApi = false;\n\n  static get editingPage() {\n    return this._editingPage;\n  }\n\n  static set editingPage(editingPage) {\n    this._editingPage = editingPage;\n    if (isBrowser && isIframe) {\n      if (editingPage) {\n        document.body.classList.add('builder-editing-page');\n      } else {\n        document.body.classList.remove('builder-editing-page');\n      }\n    }\n  }\n\n  private static prepareComponentSpecToSend(spec: Component): Component {\n    return {\n      ...spec,\n      ...(spec.inputs && {\n        inputs: spec.inputs.map((input: any) => {\n          // TODO: do for nexted fields too\n          // TODO: probably just convert all functions, not just\n          // TODO: put this in input hooks: { onChange: ..., showIf: ... }\n          const keysToConvertFnToString = ['onChange', 'showIf'];\n\n          for (const key of keysToConvertFnToString) {\n            if (input[key] && typeof input[key] === 'function') {\n              const fn = input[key];\n              input = {\n                ...input,\n                [key]: `return (${fn.toString()}).apply(this, arguments)`,\n              };\n            }\n          }\n\n          return input;\n        }),\n      }),\n      hooks: Object.keys(spec.hooks || {}).reduce((memo, key) => {\n        const value = spec.hooks && spec.hooks[key];\n        if (!value) {\n          return memo;\n        }\n        if (typeof value === 'string') {\n          memo[key] = value;\n        } else {\n          memo[key] = `return (${value.toString()}).apply(this, arguments)`;\n        }\n        return memo;\n      }, {} as { [key: string]: string }),\n      class: undefined,\n    };\n  }\n\n  static registerBlock(component: any, options: Component) {\n    this.registerComponent(component, options);\n  }\n\n  static registerComponent(component: any, options: Component) {\n    const spec = {\n      class: component,\n      ...component.builderOptions,\n      ...options,\n    };\n    this.addComponent(spec);\n    const editable =\n      options.models && this.singletonInstance.editingModel\n        ? isBrowser && options.models.includes(this.singletonInstance.editingModel)\n        : isBrowser;\n    if (editable) {\n      const sendSpec = this.prepareComponentSpecToSend(spec);\n      window.parent?.postMessage(\n        {\n          type: 'builder.registerComponent',\n          data: sendSpec,\n        },\n        '*'\n      );\n    }\n  }\n\n  private static addComponent(component: Component) {\n    const current = find(this.components, item => item.name === component.name);\n    if (current) {\n      // FIXME: why does sometimes we get an extra post without class - probably\n      // from postMessage handler wrong in some place\n      if (current.class && !component.class) {\n        return;\n      }\n      this.components.splice(this.components.indexOf(current), 1, component);\n    } else {\n      this.components.push(component);\n    }\n  }\n\n  // TODO: style guide, etc off this system as well?\n  static component(info: Partial<Component> = {}) {\n    return (component: Class) => {\n      const spec = { ...info, class: component };\n      if (!spec.name) {\n        spec.name = component.name;\n      }\n      this.addComponent(spec as Component);\n\n      const sendSpec = this.prepareComponentSpecToSend(spec as Component);\n      // TODO: serialize component name and inputs\n      if (isBrowser) {\n        window.parent?.postMessage(\n          {\n            type: 'builder.registerComponent',\n            data: sendSpec,\n          },\n          '*'\n        );\n      }\n      return component;\n    };\n  }\n\n  static isReact = false;\n\n  static get Component() {\n    return this.component;\n  }\n\n  private eventsQueue: Event[] = [];\n\n  private throttledClearEventsQueue = throttle(() => {\n    this.processEventsQueue();\n    // Extend the session cookie\n    this.setCookie(sessionStorageKey, this.sessionId, datePlusMinutes(30));\n  }, 5);\n\n  private processEventsQueue() {\n    if (!this.eventsQueue.length) {\n      return;\n    }\n    const events = this.eventsQueue;\n    this.eventsQueue = [];\n\n    const fullUserAttributes = {\n      ...Builder.overrideUserAttributes,\n      ...this.trackingUserAttributes,\n    };\n    for (const event of events) {\n      if (!event.data.metadata) {\n        event.data.metadata = {};\n      }\n      if (!event.data.metadata.user) {\n        event.data.metadata.user = {};\n      }\n      Object.assign(event.data.metadata.user, fullUserAttributes, event.data.metadata.user);\n    }\n\n    const host = this.host;\n\n    fetch(`${host}/api/v1/track`, {\n      method: 'POST',\n      body: JSON.stringify({ events }),\n      headers: {\n        'content-type': 'application/json',\n      },\n      mode: 'cors',\n    }).catch(() => {\n      // Not the end of the world\n    });\n  }\n\n  env: string = 'production';\n\n  sessionId = this.getSessionId();\n\n  targetContent = true;\n\n  contentPerRequest = 1;\n\n  // TODO: make array or function\n  allowCustomFonts = true;\n\n  private cookies: Cookies | null = null;\n\n  // TODO: api options object\n  private cachebust = false;\n  private overrideParams = '';\n  private noCache = false;\n  private preview = false;\n\n  get browserTrackingDisabled() {\n    return Boolean(Builder.isBrowser && (window as any).builderNoTrack);\n  }\n\n  get canTrack() {\n    return this.canTrack$.value;\n  }\n\n  set canTrack(canTrack) {\n    if (this.canTrack !== canTrack) {\n      this.canTrack$.next(canTrack);\n    }\n  }\n\n  private canTrack$ = new BehaviorSubject(!this.browserTrackingDisabled);\n  private apiKey$ = new BehaviorSubject<string | null>(null);\n  private authToken$ = new BehaviorSubject<string | null>(null);\n\n  userAttributesChanged = new BehaviorSubject<any>(null);\n\n  get editingMode() {\n    return this.editingMode$.value;\n  }\n\n  set editingMode(value) {\n    if (value !== this.editingMode) {\n      this.editingMode$.next(value);\n    }\n  }\n\n  editingMode$ = new BehaviorSubject(isIframe);\n\n  get editingModel() {\n    return this.editingModel$.value;\n  }\n\n  set editingModel(value) {\n    if (value !== this.editingModel) {\n      this.editingModel$.next(value);\n    }\n  }\n\n  private findParentElement(\n    target: HTMLElement,\n    callback: (element: HTMLElement) => boolean,\n    checkElement = true\n  ): HTMLElement | null {\n    if (!(target instanceof HTMLElement)) {\n      return null;\n    }\n    let parent: HTMLElement | null = checkElement ? target : target.parentElement;\n    do {\n      if (!parent) {\n        return null;\n      }\n\n      const matches = callback(parent);\n      if (matches) {\n        return parent;\n      }\n    } while ((parent = parent.parentElement));\n\n    return null;\n  }\n\n  private findBuilderParent(target: HTMLElement) {\n    return this.findParentElement(target, el => {\n      const id = el.getAttribute('builder-id') || el.id;\n      return Boolean(id && id.indexOf('builder-') === 0);\n    });\n  }\n\n  // TODO: decorator to do this stuff with the get/set (how do with typing too? compiler?)\n  editingModel$ = new BehaviorSubject<null | string>(null);\n\n  setUserAgent(userAgent: string) {\n    this.userAgent = userAgent || '';\n  }\n  userAgent: string = (typeof navigator === 'object' && navigator.userAgent) || '';\n\n  trackingHooks: TrackingHook[] = [];\n\n  /**\n   * Set a hook to modify events being tracked from builder, such as impressions and clicks\n   *\n   * For example, to track the model ID of each event associated with content for querying\n   * by mode, you can do\n   *\n   *    builder.setTrackingHook((event, context) => {\n   *      if (context.content) {\n   *        event.data.metadata.modelId = context.content.modelId\n   *      }\n   *    })\n   */\n  setTrackingHook(hook: TrackingHook) {\n    this.trackingHooks.push(hook);\n  }\n\n  track(eventName: string, properties: Partial<EventData> = {}, context?: any) {\n    // TODO: queue up track requests and fire them off when canTrack set to true - otherwise may get lots of clicks with no impressions\n    if (isIframe || !isBrowser || Builder.isPreviewing) {\n      return;\n    }\n\n    const apiKey = this.apiKey;\n    if (!apiKey) {\n      console.error(\n        'Builder integration error: Looks like the Builder SDK has not been initialized properly (your API key has not been set). Make sure you are calling `builder.init(\"«YOUR-API-KEY»\");` as early as possible in your application\\'s code.'\n      );\n      return;\n    }\n\n    let eventData: Event = JSON.parse(\n      JSON.stringify({\n        type: eventName,\n        data: {\n          ...omit(properties, 'meta'),\n          metadata: {\n            sdkVersion: Builder.VERSION,\n            url: location.href,\n            ...properties.meta,\n            ...properties.metadata,\n          },\n          ownerId: apiKey,\n          userAttributes: this.getUserAttributes(),\n          sessionId: this.sessionId,\n          visitorId: this.visitorId,\n        },\n      })\n    );\n\n    for (const hook of this.trackingHooks) {\n      const returnValue = hook(eventData, context || {});\n      if (returnValue) {\n        eventData = returnValue;\n      }\n    }\n\n    // batch events\n    this.eventsQueue.push(eventData);\n\n    if (this.canTrack) {\n      this.throttledClearEventsQueue();\n    }\n  }\n\n  getSessionId() {\n    let sessionId: string | null = null;\n    try {\n      if (Builder.isBrowser && typeof sessionStorage !== 'undefined') {\n        sessionId = this.getCookie(sessionStorageKey);\n      }\n    } catch (err) {\n      console.debug('Session storage error', err);\n      // It's ok\n    }\n\n    if (!sessionId) {\n      sessionId = uuid();\n    }\n\n    // Give the app a second to start up and set canTrack to false if needed\n    if (Builder.isBrowser) {\n      setTimeout(() => {\n        try {\n          if (this.canTrack) {\n            this.setCookie(sessionStorageKey, sessionId, datePlusMinutes(30));\n          }\n        } catch (err) {\n          console.debug('Cookie setting error', err);\n        }\n      });\n    }\n    return sessionId;\n  }\n\n  // Set this to control the userId\n  // TODO: allow changing it mid session and updating existing data to be associated\n  // e.g. for when a user navigates and then logs in\n  visitorId: string = this.getVisitorId();\n\n  getVisitorId() {\n    if (this.visitorId) {\n      return this.visitorId;\n    }\n    let visitorId: string | null = null;\n    try {\n      if (Builder.isBrowser && typeof localStorage !== 'undefined') {\n        // TODO: cookie instead?\n        visitorId = localStorage.getItem(localStorageKey);\n      }\n    } catch (err) {\n      console.debug('Local storage error', err);\n      // It's ok\n    }\n\n    if (!visitorId) {\n      visitorId = uuid();\n    }\n\n    this.visitorId = visitorId;\n\n    // Give the app a second to start up and set canTrack to false if needed\n    if (Builder.isBrowser) {\n      setTimeout(() => {\n        try {\n          if (this.canTrack && typeof localStorage !== 'undefined' && visitorId) {\n            localStorage.setItem(localStorageKey, visitorId);\n          }\n        } catch (err) {\n          console.debug('Session storage error', err);\n        }\n      });\n    }\n    return visitorId;\n  }\n\n  trackImpression(contentId: string, variationId?: string, properties?: any, context?: any) {\n    if (isIframe || !isBrowser || Builder.isPreviewing) {\n      return;\n    }\n    // TODO: use this.track method\n    this.track(\n      'impression',\n      {\n        contentId,\n        variationId: variationId !== contentId ? variationId : undefined,\n        metadata: properties,\n      },\n      context\n    );\n  }\n\n  trackConversion(amount?: number, customProperties?: any): void;\n  trackConversion(\n    amount?: number,\n    contentId?: string | any,\n    variationId?: string,\n    customProperties?: any,\n    context?: any\n  ) {\n    if (isIframe || !isBrowser || Builder.isPreviewing) {\n      return;\n    }\n    const meta = typeof contentId === 'object' ? contentId : customProperties;\n    const useContentId = typeof contentId === 'string' ? contentId : undefined;\n\n    this.track('conversion', { amount, variationId, meta, contentId: useContentId }, context);\n  }\n\n  autoTrack = !Builder.isBrowser\n    ? false\n    : !this.isDevelopmentEnv &&\n      !(Builder.isBrowser && location.search.indexOf('builder.preview=') !== -1);\n\n  // TODO: set this for QA\n  private get isDevelopmentEnv() {\n    // Automatic determining of development environment\n    return (\n      Builder.isIframe ||\n      (Builder.isBrowser && (location.hostname === 'localhost' || location.port !== '')) ||\n      this.env !== 'production'\n    );\n  }\n\n  trackInteraction(\n    contentId: string,\n    variationId?: string,\n    alreadyTrackedOne = false,\n    event?: MouseEvent,\n    context?: any\n  ) {\n    if (isIframe || !isBrowser || Builder.isPreviewing) {\n      return;\n    }\n    const target = event && (event.target as HTMLElement);\n    const targetBuilderElement = target && this.findBuilderParent(target);\n\n    function round(num: number) {\n      return Math.round(num * 1000) / 1000;\n    }\n\n    const metadata: any = {};\n    if (event) {\n      const { clientX, clientY } = event;\n      if (target) {\n        const targetRect = target.getBoundingClientRect();\n        const xOffset = clientX - targetRect.left;\n        const yOffset = clientY - targetRect.top;\n\n        const xRatio = round(xOffset / targetRect.width);\n        const yRatio = round(yOffset / targetRect.height);\n\n        metadata.targetOffset = {\n          x: xRatio,\n          y: yRatio,\n        };\n      }\n      if (targetBuilderElement) {\n        const targetRect = targetBuilderElement.getBoundingClientRect();\n        const xOffset = clientX - targetRect.left;\n        const yOffset = clientY - targetRect.top;\n\n        const xRatio = round(xOffset / targetRect.width);\n        const yRatio = round(yOffset / targetRect.height);\n\n        metadata.builderTargetOffset = {\n          x: xRatio,\n          y: yRatio,\n        };\n      }\n    }\n\n    const builderId =\n      targetBuilderElement &&\n      (targetBuilderElement.getAttribute('builder-id') || targetBuilderElement.id);\n\n    if (builderId && targetBuilderElement) {\n      metadata.builderElementIndex = ([] as Element[]).slice\n        .call(document.getElementsByClassName(builderId))\n        .indexOf(targetBuilderElement);\n    }\n\n    this.track(\n      'click',\n      {\n        contentId,\n        metadata,\n        variationId: variationId !== contentId ? variationId : undefined,\n        unique: !alreadyTrackedOne,\n        targetBuilderElement: builderId || undefined,\n      },\n      context\n    );\n  }\n\n  static overrideUserAttributes: Partial<UserAttributes> = {};\n\n  trackingUserAttributes: { [key: string]: any } = {};\n\n  component(info: Partial<Component> = {}) {\n    return Builder.component(info);\n  }\n\n  get apiKey() {\n    return this.apiKey$.value;\n  }\n\n  set apiKey(key: string | null) {\n    this.apiKey$.next(key);\n  }\n\n  get authToken() {\n    return this.authToken$.value;\n  }\n\n  set authToken(token: string | null) {\n    this.authToken$.next(token);\n  }\n\n  constructor(\n    apiKey: string | null = null,\n    protected request?: IncomingMessage,\n    protected response?: ServerResponse,\n    forceNewInstance = false,\n    authToken: string | null = null\n  ) {\n    // TODO: use a window variable for this perhaps, e.g. bc webcomponents may be loading builder twice\n    // with it's and react (use rollup build to fix)\n    if (Builder.isBrowser && !forceNewInstance && Builder.singletonInstance) {\n      return Builder.singletonInstance;\n    }\n\n    if (this.request && this.response) {\n      this.setUserAgent((this.request.headers['user-agent'] as string) || '');\n      this.cookies = new Cookies(this.request, this.response);\n    }\n\n    if (apiKey) {\n      this.apiKey = apiKey;\n    }\n    if (authToken) {\n      this.authToken = authToken;\n    }\n    if (isBrowser) {\n      this.bindMessageListeners();\n      // TODO: postmessage to parent the builder info for every package\n      // type: 'builder.sdk', data: { name: '@builder.io/react', version: '0.1.23' }\n      // (window as any).BUILDER_VERSION = Builder.VERSION;\n      // Ensure always one Builder global singleton\n      // TODO: some people won't want this, e.g. rakuten\n      // Maybe hide this behind symbol or on document, etc\n      // if ((window as any).Builder) {\n      //   Builder.components = (window as any).Builder.components;\n      // } else {\n      //   (window as any).Builder = Builder;\n      // }\n    }\n\n    if (isIframe) {\n      this.messageFrameLoaded();\n    }\n\n    // TODO: on destroy clear subscription\n    this.canTrack$.subscribe((value: any) => {\n      if (value) {\n        if (typeof sessionStorage !== 'undefined') {\n          try {\n            if (!sessionStorage.getItem(sessionStorageKey)) {\n              sessionStorage.setItem(sessionStorageKey, this.sessionId);\n            }\n          } catch (err) {\n            console.debug('Session storage error', err);\n          }\n        }\n        if (this.eventsQueue.length) {\n          this.throttledClearEventsQueue();\n        }\n        if (this.cookieQueue.length) {\n          this.cookieQueue.forEach(item => {\n            this.setCookie(item[0], item[1]);\n          });\n          this.cookieQueue.length = 0;\n        }\n      }\n    });\n\n    if (isBrowser) {\n      // TODO: defer so subclass constructor runs and injects location service\n      this.setTestsFromUrl();\n      // TODO: do this on every request send?\n      this.getOverridesFromQueryString();\n    }\n  }\n\n  private modifySearch(search: string) {\n    return search.replace(\n      /(^|&|\\?)(builder_.*?)=/gi,\n      (_match, group1, group2) => group1 + group2.replace(/_/g, '.') + '='\n    );\n  }\n\n  setTestsFromUrl() {\n    const search = this.getLocation().search;\n    const params = QueryString.parseDeep(this.modifySearch(search || '').substr(1));\n    const tests = params.builder && params.builder.tests;\n    if (tests && typeof tests === 'object') {\n      for (const key in tests) {\n        if (tests.hasOwnProperty(key)) {\n          this.setTestCookie(key, tests[key]);\n        }\n      }\n    }\n  }\n\n  resetOverrides() {\n    // Ugly - pass down instances per request instead using react context\n    // or use builder.get('foo', { req, res }) in react...........\n    Builder.overrideUserAttributes = {};\n    this.cachebust = false;\n    this.noCache = false;\n    this.preview = false;\n    this.editingModel = null;\n    this.overrides = {};\n    this.env = 'production';\n    this.userAgent = '';\n    this.request = undefined;\n    this.response = undefined;\n  }\n\n  getOverridesFromQueryString() {\n    const location = this.getLocation();\n    const params = QueryString.parseDeep(this.modifySearch(location.search || '').substr(1));\n    const { builder } = params;\n    if (builder) {\n      const {\n        userAttributes,\n        overrides,\n        env,\n        host,\n        api,\n        cachebust,\n        noCache,\n        preview,\n        editing,\n        frameEditing,\n        params: overrideParams,\n      } = builder;\n\n      if (userAttributes) {\n        this.setUserAttributes(userAttributes);\n      }\n\n      if (overrides) {\n        this.overrides = overrides;\n      }\n\n      if (validEnvList.indexOf(env || api) > -1) {\n        this.env = env || api;\n      }\n\n      if (Builder.isEditing) {\n        const editingModel = frameEditing || editing || preview;\n        if (editingModel && editingModel !== 'true') {\n          this.editingModel = editingModel;\n        }\n      }\n\n      if (cachebust) {\n        this.cachebust = true;\n      }\n\n      if (noCache) {\n        this.noCache = true;\n      }\n\n      if (preview) {\n        this.preview = true;\n      }\n\n      if (params) {\n        this.overrideParams = overrideParams;\n      }\n    }\n  }\n\n  private messageFrameLoaded() {\n    window.parent?.postMessage(\n      {\n        type: 'builder.loaded',\n        data: {\n          value: true,\n        },\n      },\n      '*'\n    );\n  }\n\n  private blockContentLoading = '';\n\n  private bindMessageListeners() {\n    if (isBrowser) {\n      addEventListener('message', event => {\n        const url = parse(event.origin);\n        const isRestricted =\n          ['builder.register', 'builder.registerComponent'].indexOf(event.data?.type) === -1;\n        const isTrusted = url.hostname && Builder.isTrustedHost(url.hostname);\n        if (isRestricted && !isTrusted) {\n          return;\n        }\n\n        const { data } = event;\n        if (data) {\n          switch (data.type) {\n            case 'builder.ping': {\n              window.parent?.postMessage(\n                {\n                  type: 'builder.pong',\n                  data: {},\n                },\n                '*'\n              );\n              break;\n            }\n            case 'builder.register': {\n              // TODO: possibly do this for all...\n              if (event.source === window) {\n                break;\n              }\n              const options = data.data;\n              if (!options) {\n                break;\n              }\n              const { type, info } = options;\n              // TODO: all must have name and can't conflict?\n              let typeList = Builder.registry[type];\n              if (!typeList) {\n                typeList = Builder.registry[type] = [];\n              }\n              typeList.push(info);\n              Builder.registryChange.next(Builder.registry);\n              break;\n            }\n            case 'builder.settingsChange': {\n              // TODO: possibly do this for all...\n              if (event.source === window) {\n                break;\n              }\n              const settings = data.data;\n              if (!settings) {\n                break;\n              }\n              Object.assign(Builder.settings, settings);\n              Builder.settingsChange.next(Builder.settings);\n              break;\n            }\n            case 'builder.registerEditor': {\n              // TODO: possibly do this for all...\n              if (event.source === window) {\n                break;\n              }\n              const info = data.data;\n              if (!info) {\n                break;\n              }\n              const hasComponent = !!info.component;\n              Builder.editors.every((thisInfo, index) => {\n                if (info.name === thisInfo.name) {\n                  if (thisInfo.component && !hasComponent) {\n                    return false;\n                  } else {\n                    Builder.editors[index] = thisInfo;\n                  }\n                  return false;\n                }\n                return true;\n              });\n              break;\n            }\n            case 'builder.triggerAnimation': {\n              Builder.animator.triggerAnimation(data.data);\n              break;\n            }\n            case 'builder.contentUpdate':\n              const key =\n                data.data.key || data.data.alias || data.data.entry || data.data.modelName;\n              const contentData = data.data.data; // hmmm...\n              const observer = this.observersByKey[key];\n              if (observer && !this.noEditorUpdates[key]) {\n                observer.next([contentData]);\n              }\n              break;\n\n            case 'builder.getComponents':\n              window.parent?.postMessage(\n                {\n                  type: 'builder.components',\n                  data: Builder.components.map(item => Builder.prepareComponentSpecToSend(item)),\n                },\n                '*'\n              );\n              break;\n\n            case 'builder.editingModel':\n              this.editingModel = data.data.model;\n              break;\n\n            case 'builder.registerComponent':\n              const componentData = data.data;\n              Builder.addComponent(componentData);\n              break;\n\n            case 'builder.blockContentLoading':\n              if (typeof data.data.model === 'string') {\n                this.blockContentLoading = data.data.model;\n              }\n              break;\n\n            case 'builder.editingMode':\n              const editingMode = data.data;\n              if (editingMode) {\n                this.editingMode = true;\n                document.body.classList.add('builder-editing');\n              } else {\n                this.editingMode = false;\n                document.body.classList.remove('builder-editing');\n              }\n              break;\n\n            case 'builder.editingPageMode':\n              const editingPageMode = data.data;\n              Builder.editingPage = editingPageMode;\n              break;\n\n            case 'builder.overrideUserAttributes':\n              const userAttributes = data.data;\n              assign(Builder.overrideUserAttributes, userAttributes);\n              this.flushGetContentQueue(true);\n              // TODO: refetch too\n              break;\n\n            case 'builder.overrideTestGroup':\n              const { variationId, contentId } = data.data;\n              if (variationId && contentId) {\n                this.setTestCookie(contentId, variationId);\n                this.flushGetContentQueue(true);\n              }\n              break;\n            case 'builder.evaluate': {\n              const text = data.data.text;\n              const args = data.data.arguments || [];\n              const id = data.data.id;\n              // tslint:disable-next-line:no-function-constructor-with-string-args\n              const fn = new Function(text);\n              let result: any;\n              let error: Error | null = null;\n              try {\n                result = fn.apply(this, args);\n              } catch (err) {\n                error = err;\n              }\n\n              if (error) {\n                window.parent?.postMessage(\n                  {\n                    type: 'builder.evaluateError',\n                    data: { id, error: error.message },\n                  },\n                  '*'\n                );\n              } else {\n                if (result && typeof result.then === 'function') {\n                  (result as Promise<any>)\n                    .then(finalResult => {\n                      window.parent?.postMessage(\n                        {\n                          type: 'builder.evaluateResult',\n                          data: { id, result: finalResult },\n                        },\n                        '*'\n                      );\n                    })\n                    .catch(console.error);\n                } else {\n                  window.parent?.postMessage(\n                    {\n                      type: 'builder.evaluateResult',\n                      data: { result, id },\n                    },\n                    '*'\n                  );\n                }\n              }\n              break;\n            }\n          }\n        }\n      });\n    }\n  }\n\n  observersByKey: { [key: string]: BehaviorSubject<BuilderContent[]> | undefined } = {};\n  noEditorUpdates: { [key: string]: boolean } = {};\n\n  get defaultCanTrack() {\n    return Boolean(\n      Builder.isBrowser &&\n        navigator.userAgent.trim() &&\n        !navigator.userAgent.match(\n          /bot|crawler|spider|robot|crawling|prerender|google|baidu|bing|msn|duckduckbot|teoma|slurp|yandex|phantom|headless|selenium|puppeteer/i\n        ) &&\n        !this.browserTrackingDisabled\n    );\n  }\n\n  init(\n    apiKey: string,\n    canTrack = this.defaultCanTrack,\n    req?: IncomingMessage,\n    res?: ServerResponse,\n    authToken?: string\n  ) {\n    if (req) {\n      this.request = req;\n    }\n    if (res) {\n      this.response = res;\n    }\n    this.canTrack = canTrack;\n    this.apiKey = apiKey;\n    if (authToken) {\n      this.authToken = authToken;\n    }\n    return this;\n  }\n\n  get previewingModel() {\n    const search = this.getLocation().search;\n    const params = QueryString.parse((search || '').substr(1));\n    return params['builder.preview'];\n  }\n\n  // TODO: allow adding location object as property and/or in constructor\n  getLocation(): Url {\n    let parsedLocation: any = {};\n\n    // in ssr mode\n    if (this.request) {\n      parsedLocation = parse(this.request.url);\n    } else if (typeof location === 'object') {\n      // in the browser\n      parsedLocation = parse(location.href);\n    }\n\n    // IE11 bug with parsed path being empty string\n    // causes issues with our user targeting\n    if (parsedLocation.pathname === '') {\n      parsedLocation.pathname = '/';\n    }\n\n    return parsedLocation;\n  }\n\n  getUserAttributes(userAgent = this.userAgent || '') {\n    const isMobile = {\n      Android() {\n        return userAgent.match(/Android/i);\n      },\n      BlackBerry() {\n        return userAgent.match(/BlackBerry/i);\n      },\n      iOS() {\n        return userAgent.match(/iPhone|iPod/i);\n      },\n      Opera() {\n        return userAgent.match(/Opera Mini/i);\n      },\n      Windows() {\n        return userAgent.match(/IEMobile/i) || userAgent.match(/WPDesktop/i);\n      },\n      any() {\n        return (\n          isMobile.Android() ||\n          isMobile.BlackBerry() ||\n          isMobile.iOS() ||\n          isMobile.Opera() ||\n          isMobile.Windows()\n        );\n      },\n    };\n\n    const isTablet = userAgent.match(/Tablet|iPad/i);\n\n    const url = this.getLocation();\n\n    return {\n      urlPath: url.pathname,\n      host: url.host || url.hostname,\n      // TODO: maybe an option to choose to target off of mobile/tablet/desktop or just mobile/desktop\n      device: isTablet ? 'tablet' : isMobile.any() ? 'mobile' : 'desktop',\n      ...Builder.overrideUserAttributes,\n    } as UserAttributes;\n  }\n\n  protected overrides: { [key: string]: string } = {};\n  private getContentQueue: null | GetContentOptions[] = null;\n  private priorContentQueue: null | GetContentOptions[] = null;\n\n  setUserAttributes(options: object) {\n    assign(Builder.overrideUserAttributes, options);\n    this.userAttributesChanged.next(options);\n  }\n\n  /**\n   * Set user attributes just for tracking purposes.\n   *\n   * Do this so properties exist on event objects for querying insights, but\n   * won't affect targeting\n   *\n   * Use this when you want to track properties but don't need to target off\n   * of them to optimize cache efficiency\n   */\n  setTrackingUserAttributes(attributes: object) {\n    assign(this.trackingUserAttributes, attributes);\n  }\n\n  get(\n    modelName: string,\n    options: GetContentOptions & {\n      req?: IncomingMessage;\n      res?: ServerResponse;\n      apiKey?: string;\n      authToken?: string;\n    } = {}\n  ) {\n    let instance: Builder = this;\n    if (!Builder.isBrowser) {\n      instance = new Builder(\n        options.apiKey || this.apiKey,\n        options.req,\n        options.res,\n        undefined,\n        options.authToken || this.authToken\n      );\n      instance.setUserAttributes(this.getUserAttributes());\n    } else {\n      if (options.apiKey && !this.apiKey) {\n        this.apiKey = options.apiKey;\n      }\n      if (options.authToken && !this.authToken) {\n        this.authToken = options.authToken;\n      }\n    }\n    return instance.queueGetContent(modelName, options).map(\n      /* map( */ (matches: any[] | null) => {\n        const match = matches && matches[0];\n        if (Builder.isStatic) {\n          return match;\n        }\n\n        const matchData = match && match.data;\n        if (!matchData) {\n          return null;\n        }\n\n        if (typeof matchData.blocksString !== 'undefined') {\n          matchData.blocks = JSON.parse(matchData.blocksString);\n          delete matchData.blocksString;\n        }\n\n        return {\n          // TODO: add ab test info here and other high level stuff\n          data: matchData,\n          id: match.id,\n          variationId: match.testVariationId || match.variationId || null,\n          testVariationId: match.testVariationId || match.variationId || null,\n          testVariationName: match.testVariationName || null,\n          lastUpdated: match.lastUpdated || null,\n        };\n      }\n    );\n    // );\n  }\n\n  // TODO: entry id in options\n  queueGetContent(modelName: string, options: GetContentOptions = {}) {\n    // TODO: if query do modelName + query\n    const key =\n      options.key ||\n      options.alias ||\n      // TODO: SDKs only pass entry key when given to them, and never when editing...\n      // options.entry ||\n\n      // TODO: this is ugly - instead of multiple of same model with different options are sent\n      // say requires key/alias. Or if not perhaps make a reliable hash of the options and use that.\n      // TODO: store last user state on last request and if user attributes different now\n      // give a warning that need to use keys to request new contente\n      // (options &&\n      //   Object.keys(options).filter(key => key !== 'model').length &&\n      //   JSON.stringify({ model: modelName, ...options, initialContent: undefined })) ||\n      modelName;\n\n    const isEditingThisModel = this.editingModel === modelName;\n    // TODO: include params in this key........\n    const currentObservable = this.observersByKey[key] as BehaviorSubject<BuilderContent[]> | null;\n\n    // if (options.query && options.query._id) {\n    //   this.flushGetContentQueue([options])\n    // }\n\n    if (this.apiKey === 'DEMO' && !this.overrides[key] && !options.initialContent) {\n      options.initialContent = [];\n    }\n\n    const { initialContent } = options;\n\n    // TODO: refresh option in options\n    if (currentObservable && (!currentObservable.value || options.cache)) {\n      // TODO: test if this ran, otherwise on 404 some observers may never be called...\n      if (currentObservable.value) {\n        nextTick(() => {\n          // TODO: return a new observable and only that one fires subscribers, don't refire for existing ones\n          currentObservable.next(currentObservable.value);\n        });\n      }\n      return currentObservable;\n    }\n    if (isEditingThisModel) {\n      if (Builder.isBrowser) {\n        parent.postMessage({ type: 'builder.updateContent', data: { options } }, '*');\n      }\n    }\n    if (!initialContent /* || isEditingThisModel */) {\n      if (!this.getContentQueue) {\n        this.getContentQueue = [];\n      }\n\n      this.getContentQueue.push({ ...options, model: modelName, key });\n      if (this.getContentQueue && this.getContentQueue.length >= this.contentPerRequest) {\n        const queue = this.getContentQueue.slice();\n        this.getContentQueue = [];\n        nextTick(() => {\n          this.flushGetContentQueue(false, queue);\n        });\n      } else {\n        nextTick(() => {\n          this.flushGetContentQueue();\n        });\n      }\n    }\n\n    const observable = new BehaviorSubject<BuilderContent[]>(null as any);\n    this.observersByKey[key] = observable;\n    if (options.noEditorUpdates) {\n      this.noEditorUpdates[key] = true;\n    }\n    if (initialContent) {\n      nextTick(() => {\n        // TODO: need to testModify this I think...?\n        observable.next(initialContent);\n      });\n    }\n    return observable;\n  }\n\n  requestUrl(\n    url: string,\n    options?: { headers: { [header: string]: number | string | string[] | undefined } }\n  ) {\n    if (Builder.isBrowser) {\n      return fetch(url, options as SimplifiedFetchOptions).then(res => res.json());\n    }\n    return new Promise((resolve, reject) => {\n      const parsedUrl = parse(url);\n      const module =\n        parsedUrl.protocol === 'http:' ? serverOnlyRequire('http') : serverOnlyRequire('https');\n      const requestOptions = {\n        host: parsedUrl.hostname,\n        port: parsedUrl.port,\n        path: parsedUrl.pathname + parsedUrl.search,\n        headers: { ...options?.headers },\n      };\n      module\n        .get(requestOptions, function (resp: any) {\n          let data = '';\n\n          // A chunk of data has been recieved.\n          resp.on('data', (chunk: string | Buffer) => {\n            data += chunk;\n          });\n\n          // The whole response has been received. Print out the result.\n          resp.on('end', () => {\n            try {\n              resolve(JSON.parse(data));\n            } catch (err) {\n              reject(err);\n            }\n          });\n        })\n        .on('error', (error: any) => {\n          reject(error);\n        });\n    });\n  }\n\n  get host() {\n    switch (this.env) {\n      case 'qa':\n        return 'https://qa.builder.io';\n      case 'test':\n        return 'https://builder-io-test.web.app';\n      case 'fast':\n        return 'https://fast.builder.io';\n      case 'cloud':\n        return 'https://cloud.builder.io';\n      case 'cdn2':\n        return 'https://cdn2.builder.io';\n      case 'cdn-qa':\n        return 'https://cdn-qa.builder.io';\n      case 'development':\n      case 'dev':\n        return 'http://localhost:5000';\n      case 'cdn-prod':\n        return 'https://cdn.builder.io';\n      default:\n        return Builder.overrideHost || 'https://cdn.builder.io';\n    }\n  }\n\n  private flushGetContentQueue(usePastQueue = false, useQueue?: GetContentOptions[]) {\n    if (!this.apiKey) {\n      throw new Error(\n        `Fetching content failed, expected apiKey to be defined instead got: ${this.apiKey}`\n      );\n    }\n\n    if (!usePastQueue && !this.getContentQueue) {\n      return;\n    }\n\n    const queue = useQueue || (usePastQueue ? this.priorContentQueue : this.getContentQueue) || [];\n\n    // TODO: do this on every request send?\n    this.getOverridesFromQueryString();\n\n    const queryParams: ParamsMap = {\n      // TODO: way to force a request to be in a separate queue. or just lower queue limit to be 1 by default\n      omit: queue[0].omit || 'meta.componentsUsed',\n      apiKey: this.apiKey,\n      ...queue[0].options,\n    };\n    if (queue[0].fields) {\n      queryParams.fields = queue[0].fields;\n    }\n    if (queue[0].format) {\n      queryParams.format = queue[0].format;\n    }\n\n    const pageQueryParams: ParamsMap =\n      typeof location !== 'undefined'\n        ? QueryString.parseDeep(location.search.substr(1))\n        : undefined || {};\n\n    const userAttributes =\n      // FIXME: HACK: only checks first in queue for user attributes overrides, should check all\n      // TODO: merge user attributes provided here with defaults and current user attiributes (?)\n      queue && queue[0].userAttributes\n        ? queue[0].userAttributes\n        : this.targetContent\n        ? this.getUserAttributes()\n        : {\n            urlPath: this.getLocation().pathname,\n          };\n\n    const fullUrlQueueItem = queue.find(item => !!item.includeUrl);\n    if (fullUrlQueueItem) {\n      const location = this.getLocation();\n      if (location.origin) {\n        queryParams.url = `${location.origin}${location.pathname}${location.search}`;\n      }\n    }\n\n    const urlQueueItem = useQueue?.find(item => item.url);\n    if (urlQueueItem?.url) {\n      userAttributes.urlPath = urlQueueItem.url.split('?')[0];\n    }\n    // TODO: merge in the attribute from query string ones\n    // TODO: make this an option per component/request\n    queryParams.userAttributes = userAttributes;\n\n    if (!usePastQueue && !useQueue) {\n      this.priorContentQueue = queue;\n      this.getContentQueue = null;\n    }\n\n    const cachebust =\n      this.cachebust ||\n      isIframe ||\n      pageQueryParams.cachebust ||\n      pageQueryParams['builder.cachebust'];\n\n    if (cachebust || this.env !== 'production') {\n      queryParams.cachebust = true;\n    }\n\n    if (Builder.isEditing) {\n      queryParams.isEditing = true;\n    }\n\n    if (this.noCache || this.env !== 'production') {\n      queryParams.noCache = true;\n    }\n\n    if (size(this.overrides)) {\n      for (const key in this.overrides) {\n        if (this.overrides.hasOwnProperty(key)) {\n          queryParams[`overrides.${key}`] = this.overrides[key];\n        }\n      }\n    }\n\n    if (!Builder.isReact) {\n      // TODO: remove me once v1 page editors converted to v2\n      // queryParams.extractCss = true;\n      queryParams.prerender = true;\n    }\n\n    for (const options of queue) {\n      if (options.format) {\n        queryParams.format = options.format;\n      }\n      // TODO: remove me and make permodel\n      if (options.static) {\n        queryParams.static = options.static;\n      }\n\n      if (options.cachebust) {\n        queryParams.cachebust = options.cachebust;\n      }\n\n      if (isPositiveNumber(options.cacheSeconds)) {\n        queryParams.cacheSeconds = options.cacheSeconds;\n      }\n\n      if (isPositiveNumber(options.staleCacheSeconds)) {\n        queryParams.staleCacheSeconds = options.staleCacheSeconds;\n      }\n\n      const properties: (keyof GetContentOptions)[] = [\n        'prerender',\n        'extractCss',\n        'limit',\n        'offset',\n        'query',\n        'preview',\n        'model',\n        'entry',\n        'rev',\n        'static',\n      ];\n      for (const key of properties) {\n        const value = options[key];\n        if (value !== undefined) {\n          queryParams.options = queryParams.options || {};\n          queryParams.options[options.key!] = queryParams.options[options.key!] || {};\n          queryParams.options[options.key!][key] = JSON.stringify(value);\n        }\n      }\n    }\n    if (this.preview) {\n      queryParams.preview = 'true';\n    }\n    const hasParams = Object.keys(queryParams).length > 0;\n\n    // TODO: option to force dev or qa api here\n    const host = this.host;\n\n    const keyNames = queue.map(item => encodeURIComponent(item.key!)).join(',');\n\n    if (this.overrideParams) {\n      const params = omit(QueryString.parse(this.overrideParams), 'apiKey');\n      assign(queryParams, params);\n    }\n\n    const queryStr = QueryString.stringifyDeep(queryParams);\n\n    const format = queryParams.format;\n\n    const requestOptions = { headers: {} };\n    if (this.authToken) {\n      requestOptions.headers = {\n        ...requestOptions.headers,\n        Authorization: `Bearer ${this.authToken}`,\n      };\n    }\n\n    const promise = this.requestUrl(\n      `${host}/api/v1/${format === 'solid' || format === 'react' ? 'codegen' : 'query'}/${\n        this.apiKey\n      }/${keyNames}` + (queryParams && hasParams ? `?${queryStr}` : ''),\n      requestOptions\n    ).then(\n      result => {\n        for (const options of queue) {\n          const keyName = options.key!;\n          if (options.model === this.blockContentLoading && !options.noEditorUpdates) {\n            continue;\n          }\n\n          const isEditingThisModel = this.editingModel === options.model;\n          if (isEditingThisModel && Builder.isEditing) {\n            parent.postMessage({ type: 'builder.updateContent', data: { options } }, '*');\n            // return;\n          }\n          const observer = this.observersByKey[keyName];\n          if (!observer) {\n            return;\n          }\n          const data = result[keyName];\n          const sorted = data; // sortBy(data, item => item.priority);\n          if (data) {\n            const testModifiedResults = Builder.isServer\n              ? sorted\n              : this.processResultsForTests(sorted);\n            observer.next(testModifiedResults);\n          } else {\n            const search = this.getLocation().search;\n            if ((search || '').includes('builder.preview=' + options.model)) {\n              const previewData = {\n                id: 'preview',\n                name: 'Preview',\n                data: {},\n              };\n              observer.next([previewData]);\n            }\n            observer.next([]);\n          }\n        }\n      },\n      err => {\n        for (const options of queue) {\n          const observer = this.observersByKey[options.key!];\n          if (!observer) {\n            return;\n          }\n          observer.error(err);\n        }\n      }\n    );\n\n    return promise;\n  }\n\n  private testCookiePrefix = 'builder.tests';\n\n  private processResultsForTests(results: BuilderContent[]) {\n    const mappedResults = results.map(item => {\n      if (!item.variations) {\n        return item;\n      }\n      const cookieValue = this.getTestCookie(item.id!);\n      const cookieVariation = cookieValue === item.id ? item : item.variations[cookieValue];\n      if (cookieVariation) {\n        return {\n          ...item,\n          data: cookieVariation.data,\n          variationId: cookieValue,\n          testVariationId: cookieValue,\n          testVariationName: cookieVariation.name,\n        };\n      }\n      if (this.canTrack && item.variations && size(item.variations)) {\n        let n = 0;\n        const random = Math.random();\n        for (const id in item.variations) {\n          const variation = item.variations[id]!;\n          const testRatio = variation.testRatio;\n          n += testRatio!;\n          if (random < n) {\n            this.setTestCookie(item.id!, variation.id!);\n            const variationName =\n              variation.name || (variation.id === item.id ? 'Default variation' : '');\n            return {\n              ...item,\n              data: variation.data,\n              variationId: variation.id,\n              testVariationId: variation.id,\n              variationName: variationName,\n              testVariationName: variationName,\n            };\n          }\n        }\n        this.setTestCookie(item.id!, item.id!);\n      }\n      return {\n        ...item,\n        variationId: item.id,\n        ...(item.variations &&\n          size(item.variations) && {\n            testVariationId: item.id,\n            testVariationName: 'Default variation',\n          }),\n      };\n    });\n\n    if (isIframe) {\n      window.parent?.postMessage(\n        { type: 'builder.contentResults', data: { results: mappedResults } },\n        '*'\n      );\n    }\n\n    return mappedResults;\n  }\n\n  private getTestCookie(contentId: string) {\n    return this.getCookie(`${this.testCookiePrefix}.${contentId}`);\n  }\n\n  private cookieQueue: [string, string][] = [];\n\n  private setTestCookie(contentId: string, variationId: string) {\n    if (!this.canTrack) {\n      this.cookieQueue.push([contentId, variationId]);\n      return;\n    }\n\n    // 30 days from now\n    const future = new Date();\n    future.setDate(future.getDate() + 30);\n\n    return this.setCookie(`${this.testCookiePrefix}.${contentId}`, variationId, future);\n  }\n\n  getCookie(name: string): any {\n    if (this.cookies) {\n      return this.cookies.get(name);\n    }\n    return Builder.isBrowser && getCookie(name);\n  }\n\n  setCookie(name: string, value: any, expires?: Date) {\n    if (this.cookies && !(Builder.isServer && Builder.isStatic)) {\n      return this.cookies.set(name, value, {\n        expires,\n        secure: this.getLocation().protocol === 'https:',\n      });\n    }\n    return Builder.isBrowser && setCookie(name, value, expires);\n  }\n\n  getContent(modelName: string, options: GetContentOptions = {}) {\n    if (!this.apiKey) {\n      throw new Error(\n        `Fetching content from model ${modelName} failed, expected apiKey to be defined instead got: ${this.apiKey}`\n      );\n    }\n    return this.queueGetContent(modelName, options);\n  }\n\n  getAll(\n    modelName: string,\n    options: GetContentOptions & {\n      req?: IncomingMessage;\n      res?: ServerResponse;\n      apiKey?: string;\n    } = {}\n  ): Promise<BuilderContent[]> {\n    let instance: Builder = this;\n    if (!Builder.isBrowser) {\n      instance = new Builder(options.apiKey || this.apiKey, options.req, options.res);\n      instance.setUserAttributes(this.getUserAttributes());\n    } else {\n      if (options.apiKey && !this.apiKey) {\n        this.apiKey = options.apiKey;\n      }\n    }\n\n    return instance\n      .getContent(modelName, {\n        limit: 30,\n        ...options,\n        key:\n          options.key ||\n          // Make the key include all options so we don't reuse cache for the same conent fetched\n          // with different options\n          Builder.isBrowser\n            ? `${modelName}:${hash(omit(options, 'initialContent', 'req', 'res'))}`\n            : undefined,\n      })\n      .promise();\n  }\n}\n","import { Builder } from '../builder.class';\n\nexport const builder = new Builder(null, undefined, undefined, true);\nBuilder.singletonInstance = builder;\n"],"names":["window","CustomEvent","event","params","bubbles","cancelable","detail","evt","document","createEvent","initCustomEvent","isSafari","test","navigator","userAgent","nextTick","fn","setImmediate","MutationObserver","setTimeout","called","observer","element","createTextNode","observe","characterData","data","String","PROPERTY_NAME_DENY_LIST","Object","freeze","QueryString","queryString","obj","this","parse","deepen","map","flatten","stringify","query","pairs","substr","split","i","length","pair","decodeURIComponent","error","str","key","hasOwnProperty","value","encodeURIComponent","output","k","t","parts","pop","parts_1","_i","part","assertAllowedPropertyName","_current","_res","newKey","name","indexOf","Error","listeners","listener","Subscription","unsubscribed","subscription","otherSubscriptions","push","index","splice","forEach","sub","unsubscribe","BehaviorSubject","_a","newSubject","subscribe","val","next","catch","err","errorListener","errorListeners","Promise","resolve","reject","_this","toPromise","State","Pending","Fulfilled","Rejected","isFunction","isObject","executor","_resolve","bind","_reject","TinyPromise","x","then","called_1","thenable","call","result","_fulfill","ex","_state","_value","_handlers","handler","_callHandler","onFulfilled","onRejected","_isFulfilled","_isRejected","_addHandler","serverOnlyRequire","eval","promiseResolve","tinyFetch","url","options","request","XMLHttpRequest","open","method","headers","setRequestHeader","response","keys","all","header","undefined","getAllResponseHeaders","replace","_match","_key","toLowerCase","ok","status","statusText","responseURL","clone","text","responseText","json","JSON","blob","Blob","entries","get","n","has","withCredentials","credentials","onload","onerror","send","body","fetch","global","assign","target","args","to","arguments","nextSource","nextKey","prototype","throttle","func","wait","context","timeout","previous","later","leading","Date","now","apply","remaining","clearTimeout","trailing","camelCaseToKebabCase","g","Animator","animations","animations_1","animation","trigger","triggerAnimation","bindHoverAnimation","bindScrollInViewAnimation","id","console","warn","stylesUsed","getAllStylesUsed","computedStyle","getComputedStyle","bothStyles_1","steps","styles","stylesUsed_1","style","properties","step","elements","Array","slice","getElementsByClassName","elementId","from","augmentAnimation","transition","transitionDelay","duration","easing","delay","warnElementNotPresent","defaultState","hoverState","attachDefaultState","addEventListener","triggered","immediateOnScroll","rect","windowHeight","threshold","getBoundingClientRect","innerHeight","bottom","top","removeEventListener","onScroll","capture","passive","getTopLevelDomain","host","join","fieldContentRegExp","Cookies","match","getPattern","opts","res","req","getHeader","secure","protocol","connection","encrypted","cookie","Cookie","domain","pushCookie","setHeader","attrs","TypeError","expires","toString","maxAge","path","toUTCString","sameSite","httpOnly","RegExp","overwrite","toHeader","omit","values","newObject","values_1","uuidv4","c","r","Math","random","uuid","pad","hash","len","fold","charCodeAt","foldObject","o","seen","sort","reduce","foldValue","input","objHash","valueOf","stack","message","sum","datePlusMinutes","minutes","isPositiveNumber","thing","isNaN","isReactNative","product","validEnvList","getQueryParam","variable","vars","urlParser","parser","createElement","href","out","props","pathname","setCookie","expiresString","isBrowser","location","hostname","getCookie","size","object","find","callback","list","thisArg","sessionStorageKey","localStorageKey","isIframe","self","BuilderComponent","info","Builder","Component","apiKey","forceNewInstance","authToken","processEventsQueue","sessionId","getSessionId","browserTrackingDisabled","getVisitorId","isDevelopmentEnv","search","singletonInstance","setUserAgent","cookies","bindMessageListeners","messageFrameLoaded","canTrack$","sessionStorage","getItem","setItem","debug","eventsQueue","throttledClearEventsQueue","cookieQueue","item","setTestsFromUrl","getOverridesFromQueryString","type","typeList","registry","parent","postMessage","registryChange","isTrustedHost","editors","plugins","action","actions","trustedHosts","findIndex","trustedHost","endsWith","fields","settings","settingsChange","packageName","System","import","_editingPage","editingPage","classList","add","remove","spec","inputs","keysToConvertFnToString_1","hooks","memo","class","component","registerComponent","builderOptions","addComponent","models","editingModel","includes","sendSpec","prepareComponentSpecToSend","current","components","events","fullUserAttributes","overrideUserAttributes","trackingUserAttributes","events_1","event_1","metadata","user","content-type","mode","Boolean","builderNoTrack","canTrack","editingMode$","editingMode","editingModel$","checkElement","HTMLElement","parentElement","findParentElement","el","getAttribute","hook","trackingHooks","eventName","isPreviewing","eventData","sdkVersion","VERSION","meta","ownerId","userAttributes","getUserAttributes","visitorId","returnValue","localStorage","contentId","variationId","track","amount","customProperties","useContentId","port","env","alreadyTrackedOne","targetBuilderElement","findBuilderParent","clientX","clientY","xOffset","targetRect","left","yOffset","xRatio","round","width","yRatio","height","targetOffset","y","builderTargetOffset","builderId","builderElementIndex","unique","num","apiKey$","authToken$","token","group1","group2","getLocation","parseDeep","modifySearch","tests","builder","setTestCookie","cachebust","noCache","preview","overrides","api","editing","frameEditing","overrideParams","setUserAttributes","isEditing","origin","isRestricted","isTrusted","source","info_1","hasComponent_1","every","thisInfo","animator","alias","entry","modelName","contentData","observersByKey","noEditorUpdates","model","componentData","blockContentLoading","editingPageMode","flushGetContentQueue","_f","id_1","Function","finalResult","trim","defaultCanTrack","parsedLocation","isMobile","Android","BlackBerry","iOS","Opera","Windows","any","isTablet","__assign","urlPath","device","userAttributesChanged","attributes","instance","queueGetContent","matches","isStatic","matchData","blocksString","blocks","testVariationId","testVariationName","lastUpdated","isEditingThisModel","currentObservable","initialContent","cache","getContentQueue","contentPerRequest","queue_1","observable","parsedUrl","module","requestOptions","resp","on","chunk","overrideHost","usePastQueue","useQueue","queue","priorContentQueue","queryParams","format","pageQueryParams","targetContent","includeUrl","location_1","urlQueueItem","isReact","prerender","queue_2","static","cacheSeconds","staleCacheSeconds","properties_1","hasParams","keyNames","queryStr","stringifyDeep","Authorization","requestUrl","queue_3","keyName","sorted","testModifiedResults","isServer","processResultsForTests","queue_4","results","mappedResults","variations","cookieValue","getTestCookie","cookieVariation","variation","testRatio","variationName","testCookiePrefix","future","setDate","getDate","set","getContent","limit","promise","version","referrer"],"mappings":"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"}